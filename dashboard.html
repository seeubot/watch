<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicious Bites - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #F5F5F5; /* Light Gray Background */
            color: #333;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Blue & White Theme */
        :root {
            --primary-blue: #4A90E2;
            --accent-blue: #2196F3;
            --light-blue: #E3F2FD;
            --white: #FFFFFF;
            --text-dark: #333;
            --text-light: #666;
            --border-light: #E0E0E0;
            --success-green: #4CAF50;
            --error-red: #F44336;
            --warning-orange: #FF9800;
        }

        /* Layout */
        .dashboard-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--primary-blue);
            color: var(--white);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: width 0.3s ease;
            flex-shrink: 0;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5em;
            padding: 0 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar.collapsed h2 {
            font-size: 0; /* Hide text */
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--white);
            text-decoration: none;
            font-size: 1.1em;
            border-radius: 8px;
            margin: 0 10px;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .sidebar nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .sidebar nav ul li a.active {
            background-color: var(--accent-blue);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .sidebar nav ul li a i {
            margin-right: 15px;
            width: 20px; /* Ensure consistent icon width */
            text-align: center;
        }

        .sidebar.collapsed nav ul li a i {
            margin-right: 0;
        }

        .sidebar.collapsed nav ul li a span {
            display: none;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--white);
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .header h1 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 2em;
        }

        .header .user-info {
            display: flex;
            align-items: center;
        }

        .header .user-info span {
            margin-right: 15px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .header .user-info button {
            background-color: var(--error-red);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .header .user-info button:hover {
            background-color: #D32F2F;
        }

        .section {
            display: none;
            flex-grow: 1;
            padding-top: 10px;
        }

        .section.active {
            display: flex;
            flex-direction: column;
        }

        /* Common Elements */
        .card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            color: var(--primary-blue);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
        }

        .btn {
            background-color: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--border-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background-color: #D0D0D0;
        }

        .btn-danger {
            background-color: var(--error-red);
        }

        .btn-danger:hover {
            background-color: #D32F2F;
        }

        .btn-success {
            background-color: var(--success-green);
        }

        .btn-success:hover {
            background-color: #388E3C;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
        }
        
        .form-group select {
            width: 100%; /* Ensure select takes full width */
        }

        .form-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .table-container {
            overflow-x: auto; /* Enable horizontal scroll for tables on small screens */
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--white);
        }

        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        table th {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        table tbody tr:hover {
            background-color: #F9F9F9;
        }

        table td .action-buttons button {
            margin-right: 5px;
            padding: 6px 10px;
            font-size: 0.9em;
        }

        /* Specific Section Styles */
        /* WhatsApp Bot Status */
        .bot-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .bot-status-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            background-color: var(--light-blue);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .bot-status-card .status-indicator {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
            color: var(--primary-blue);
        }

        .bot-status-card .status-indicator.disconnected { color: var(--error-red); }
        .bot-status-card .status-indicator.qr_received { color: var(--warning-orange); }
        .bot-status-card .status-indicator.authenticated { color: var(--accent-blue); }
        .bot-status-card .status-indicator.ready { color: var(--success-green); }
        .bot-status-card .status-indicator.initializing { color: var(--primary-blue); }
        .bot-status-card .status-indicator.auth_failure, .bot-status-card .status-indicator.qr_error { color: var(--error-red); }


        #qrCodeDisplay {
            max-width: 200px;
            height: auto;
            margin: 15px auto;
            border: 5px solid var(--white);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #whatsappLogs {
            background-color: #f0f0f0;
            border: 1px solid var(--border-light);
            border-radius: 5px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap; /* Preserve whitespace and wrap lines */
            word-break: break-all; /* Break long words */
            color: var(--text-dark);
        }

        /* Settings Section */
        .delivery-rate-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        .delivery-rate-item .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .delivery-rate-item .btn-danger {
            height: 38px; /* Match input height */
            margin-bottom: 5px;
        }

        /* 2FA Section */
        #qrCode2FADisplay {
            max-width: 180px;
            height: auto;
            margin: 15px auto;
            border: 5px solid var(--white);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .totp-secret-display {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            text-align: center;
            margin-top: 10px;
            word-break: break-all;
            position: relative;
        }
        .totp-secret-display .copy-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 1.2em;
        }
        .totp-secret-display .copy-btn:hover {
            color: var(--accent-blue);
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background-color: var(--white);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%; /* Responsive width */
            max-width: 600px; /* Max width */
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-blue);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .modal-footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--text-light);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--error-red);
            text-decoration: none;
            cursor: pointer;
        }

        /* Toast Notifications */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--success-green);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            animation: slideIn 0.3s forwards, fadeOut 0.5s 2.5s forwards;
            min-width: 250px;
            max-width: 350px;
            word-wrap: break-word;
        }

        .toast.error { background-color: var(--error-red); }
        .toast.warning { background-color: var(--warning-orange); }
        .toast.info { background-color: var(--primary-blue); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Loading Spinner */
        #loadingSpinner {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 8px solid var(--border-light);
            border-top: 8px solid var(--primary-blue);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 10px 0;
                flex-direction: row;
                justify-content: space-around;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                position: sticky;
                top: 0;
                z-index: 900;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
            }

            .sidebar h2 {
                display: none; /* Hide title on small screens */
            }

            .sidebar nav ul {
                display: flex;
                flex-wrap: nowrap;
            }

            .sidebar nav ul li {
                margin-bottom: 0;
                flex-shrink: 0; /* Prevent items from shrinking */
            }

            .sidebar nav ul li a {
                padding: 10px 15px;
                margin: 0 5px;
                font-size: 0.9em;
                flex-direction: column;
                gap: 5px;
            }

            .sidebar nav ul li a i {
                margin-right: 0;
                margin-bottom: 5px;
            }

            .sidebar.collapsed {
                width: 100%; /* No collapse effect on mobile */
            }

            .sidebar.collapsed nav ul li a i {
                margin-right: 0;
            }

            .sidebar.collapsed nav ul li a span {
                display: block; /* Show text on mobile */
            }

            .main-content {
                margin: 10px;
                padding: 15px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header .user-info {
                width: 100%;
                justify-content: space-between;
            }

            .bot-status-grid {
                grid-template-columns: 1fr; /* Stack cards on mobile */
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            table th, table td {
                padding: 10px;
                font-size: 0.85em;
            }

            table td .action-buttons button {
                padding: 5px 8px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .header .user-info span {
                font-size: 0.9em;
            }
            .header .user-info button {
                padding: 6px 10px;
                font-size: 0.9em;
            }
            .sidebar nav ul li a {
                padding: 8px 10px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <h2>Delicious Bites</h2>
            <nav>
                <ul>
                    <li><a href="#" data-section="bot-status" class="active"><i class="fas fa-robot"></i> <span>Bot Status</span></a></li>
                    <li><a href="#" data-section="menu-management"><i class="fas fa-utensils"></i> <span>Menu Management</span></a></li>
                    <li><a href="#" data-section="order-management"><i class="fas fa-receipt"></i> <span>Order Management</span></a></li>
                    <li><a href="#" data-section="customer-management"><i class="fas fa-users"></i> <span>Customer Management</span></a></li>
                    <li><a href="#" data-section="settings"><i class="fas fa-cogs"></i> <span>Settings</span></a></li>
                    <li><a href="#" data-section="2fa-management"><i class="fas fa-shield-alt"></i> <span>2FA Management</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1 id="currentSectionTitle">Bot Status</h1>
                <div class="user-info">
                    <span>Welcome, Admin!</span>
                    <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>

            <!-- Bot Status Section -->
            <section id="bot-status" class="section active">
                <div class="bot-status-grid">
                    <div class="card bot-status-card">
                        <h3>WhatsApp Bot Status</h3>
                        <i id="botStatusIcon" class="fas fa-circle" style="font-size: 3em; color: var(--error-red);"></i>
                        <div id="botStatusText" class="status-indicator disconnected">Disconnected</div>
                        <p>Last Authenticated: <span id="lastAuthenticatedAt">N/A</span></p>
                        <button class="btn" id="forceNewSessionBtn"><i class="fas fa-sync-alt"></i> Force New Session</button>
                    </div>
                    <div class="card bot-status-card">
                        <h3>QR Code</h3>
                        <img id="qrCodeDisplay" src="" alt="QR Code" style="display: none;">
                        <p id="qrCodeMessage">Scan QR code to connect WhatsApp</p>
                    </div>
                </div>
                <div class="card">
                    <h3>WhatsApp Logs</h3>
                    <pre id="whatsappLogs"></pre>
                </div>
            </section>

            <!-- Menu Management Section -->
            <section id="menu-management" class="section">
                <div class="header-controls" style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                    <button class="btn" id="addMenuItemBtn"><i class="fas fa-plus"></i> Add New Item</button>
                </div>
                <div class="card">
                    <h3>Menu Items</h3>
                    <div class="table-container">
                        <table id="menuItemsTable">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th>Available</th>
                                    <th>Trending</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Menu items will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Order Management Section -->
            <section id="order-management" class="section">
                <div class="card">
                    <h3>Customer Orders</h3>
                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>PIN</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Payment</th>
                                    <th>Date</th>
                                    <th>Address</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Customer Management Section -->
            <section id="customer-management" class="section">
                <div class="card">
                    <h3>Customer List</h3>
                    <div class="table-container">
                        <table id="customersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Total Orders</th>
                                    <th>Last Order Date</th>
                                    <th>Last Known Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Customers will be loaded here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="section">
                <div class="card">
                    <h3>Shop Settings</h3>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label for="shopName">Shop Name</label>
                            <input type="text" id="shopName" name="shopName" required>
                        </div>
                        <div class="form-group">
                            <label>Shop Location (Latitude, Longitude)</label>
                            <input type="number" id="shopLocationLatitude" name="shopLocation.latitude" step="0.000001" placeholder="Latitude" required>
                            <input type="number" id="shopLocationLongitude" name="shopLocation.longitude" step="0.000001" placeholder="Longitude" required style="margin-top: 10px;">
                        </div>

                        <h4>Delivery Rates (KMs vs. Amount)</h4>
                        <div id="deliveryRatesContainer">
                            <!-- Delivery rate inputs will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary" id="addDeliveryRateBtn"><i class="fas fa-plus"></i> Add Delivery Rate</button>

                        <h4 style="margin-top: 25px;">Discount Settings</h4>
                        <div class="form-group">
                            <label for="minSubtotalForDiscount">Minimum Subtotal for Discount (₹)</label>
                            <input type="number" id="minSubtotalForDiscount" name="minSubtotalForDiscount" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="discountPercentage">Discount Percentage (e.g., 0.1 for 10%)</label>
                            <input type="number" id="discountPercentage" name="discountPercentage" step="0.01" min="0" max="1" required>
                        </div>

                        <div class="modal-footer" style="border-top: none; padding-top: 0; margin-top: 20px;">
                            <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save Settings</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- 2FA Management Section -->
            <section id="2fa-management" class="section">
                <div class="card">
                    <h3>Two-Factor Authentication (2FA)</h3>
                    <p>Status: <strong id="2faStatusText">Checking...</strong></p>
                    <div class="2fa-actions" style="margin-top: 20px;">
                        <button class="btn btn-success" id="enable2FABtn" style="display: none;"><i class="fas fa-lock"></i> Enable 2FA</button>
                        <button class="btn btn-danger" id="disable2FABtn" style="display: none;"><i class="fas fa-unlock"></i> Disable 2FA</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->

    <!-- Menu Item Modal -->
    <div id="menuItemModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="menuItemModal">&times;</span>
            <h3 id="menuItemModalTitle">Add New Menu Item</h3>
            <form id="menuItemForm">
                <input type="hidden" id="menuItemId">
                <div class="form-group">
                    <label for="itemName">Name</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label for="itemDescription">Description</label>
                    <textarea id="itemDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="itemPrice">Price (₹)</label>
                    <input type="number" id="itemPrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="itemImageUrl">Image URL (Optional)</label>
                    <input type="text" id="itemImageUrl">
                </div>
                <div class="form-group">
                    <label for="itemCategory">Category</label>
                    <input type="text" id="itemCategory">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="isAvailable">
                    <label for="isAvailable" style="display: inline;">Is Available</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="isTrending">
                    <label for="isTrending" style="display: inline;">Is Trending</label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-modal-id="menuItemModal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="orderDetailsModal">&times;</span>
            <h3>Order Details</h3>
            <div id="orderDetailsContent">
                <!-- Details will be loaded here by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-id="orderDetailsModal">Close</button>
            </div>
        </div>
    </div>

    <!-- Customer Latest Order Modal -->
    <div id="customerLatestOrderModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="customerLatestOrderModal">&times;</span>
            <h3>Latest Order for <span id="customerLatestOrderName"></span></h3>
            <div id="customerLatestOrderContent">
                <!-- Latest order details will be loaded here by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-id="customerLatestOrderModal">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="confirmationModal">&times;</span>
            <h3>Confirm Action</h3>
            <p id="confirmationMessage"></p>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-id="confirmationModal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmActionButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 2FA Generate Modal -->
    <div id="2faGenerateModal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="2faGenerateModal">&times;</span>
            <h3>Enable Two-Factor Authentication</h3>
            <p>Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p>
            <img id="qrCode2FADisplay" src="" alt="2FA QR Code">
            <p>Or manually enter this secret key:</p>
            <div class="totp-secret-display">
                <span id="totpSecretText"></span>
                <button class="copy-btn" onclick="copyToClipboard(document.getElementById('totpSecretText').innerText)"><i class="fas fa-copy"></i></button>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label for="totpCodeVerify">Enter 6-digit code from app to verify:</label>
                <input type="text" id="totpCodeVerify" maxlength="6" pattern="\d{6}" placeholder="XXXXXX" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal-id="2faGenerateModal">Cancel</button>
                <button type="button" class="btn btn-success" id="verify2FABtn">Verify & Enable</button>
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const API_BASE_URL = window.location.origin; // Dynamically get base URL
        const SOCKET_IO_URL = window.location.origin;

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loadingSpinner');
        const currentSectionTitle = document.getElementById('currentSectionTitle');
        const sidebarLinks = document.querySelectorAll('.sidebar nav ul li a');
        const sections = document.querySelectorAll('.section');
        const logoutBtn = document.getElementById('logoutBtn');
        const toastContainer = document.getElementById('toastContainer');

        // Modals
        const menuItemModal = document.getElementById('menuItemModal');
        const menuItemForm = document.getElementById('menuItemForm');
        const menuItemModalTitle = document.getElementById('menuItemModalTitle');
        const menuItemId = document.getElementById('menuItemId');
        const itemName = document.getElementById('itemName');
        const itemDescription = document.getElementById('itemDescription');
        const itemPrice = document.getElementById('itemPrice');
        const itemImageUrl = document.getElementById('itemImageUrl');
        const itemCategory = document.getElementById('itemCategory');
        const isAvailable = document.getElementById('isAvailable');
        const isTrending = document.getElementById('isTrending');

        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const orderDetailsContent = document.getElementById('orderDetailsContent');

        const customerLatestOrderModal = document.getElementById('customerLatestOrderModal');
        const customerLatestOrderName = document.getElementById('customerLatestOrderName');
        const customerLatestOrderContent = document.getElementById('customerLatestOrderContent');

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmActionButton = document.getElementById('confirmActionButton');

        const twoFaGenerateModal = document.getElementById('2faGenerateModal');
        const qrCode2FADisplay = document.getElementById('qrCode2FADisplay');
        const totpSecretText = document.getElementById('totpSecretText');
        const totpCodeVerify = document.getElementById('totpCodeVerify');

        // WhatsApp Bot Status
        const botStatusIcon = document.getElementById('botStatusIcon');
        const botStatusText = document.getElementById('botStatusText');
        const lastAuthenticatedAtSpan = document.getElementById('lastAuthenticatedAt');
        const qrCodeDisplay = document.getElementById('qrCodeDisplay');
        const qrCodeMessage = document.getElementById('qrCodeMessage');
        const whatsappLogs = document.getElementById('whatsappLogs');
        const forceNewSessionBtn = document.getElementById('forceNewSessionBtn');

        // Menu Management
        const addMenuItemBtn = document.getElementById('addMenuItemBtn');
        const menuItemsTableBody = document.querySelector('#menuItemsTable tbody');

        // Order Management
        const ordersTableBody = document.querySelector('#ordersTable tbody');

        // Customer Management
        const customersTableBody = document.querySelector('#customersTable tbody');

        // Settings
        const settingsForm = document.getElementById('settingsForm');
        const shopNameInput = document.getElementById('shopName');
        const shopLocationLatitudeInput = document.getElementById('shopLocationLatitude');
        const shopLocationLongitudeInput = document.getElementById('shopLocationLongitude');
        const deliveryRatesContainer = document.getElementById('deliveryRatesContainer');
        const addDeliveryRateBtn = document.getElementById('addDeliveryRateBtn');
        const minSubtotalForDiscountInput = document.getElementById('minSubtotalForDiscount');
        const discountPercentageInput = document.getElementById('discountPercentage');

        // 2FA Management
        const twoFaStatusText = document.getElementById('2faStatusText');
        const enable2FABtn = document.getElementById('enable2FABtn');
        const disable2FABtn = document.getElementById('disable2FABtn');
        const verify2FABtn = document.getElementById('verify2FABtn');

        let currentConfirmAction = null;
        let temp2FASecret = null; // Temporarily store the generated 2FA secret

        // --- Utility Functions ---

        function showLoadingSpinner() {
            loadingSpinner.style.display = 'flex';
        }

        function hideLoadingSpinner() {
            loadingSpinner.style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.classList.add(type);
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000); // Toast disappears after 3 seconds
        }

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                showToast('Session expired. Please log in again.', 'error');
                window.location.href = '/admin/login';
                return null;
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };

            showLoadingSpinner();
            try {
                const response = await fetch(url, options);
                hideLoadingSpinner();

                if (response.status === 401 || response.status === 403) {
                    showToast('Session expired or unauthorized. Please log in again.', 'error');
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/admin/login';
                    return null;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    showToast(errorData.message || `API Error: ${response.statusText}`, 'error');
                    throw new Error(errorData.message || `API Error: ${response.statusText}`);
                }
                return response;
            } catch (error) {
                hideLoadingSpinner();
                console.error('Fetch error:', error);
                showToast(`Network or API error: ${error.message}`, 'error');
                return null;
            }
        }

        function openModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function closeModal(modalElement) {
            modalElement.style.display = 'none';
        }

        function showConfirmDialog(message, onConfirmCallback) {
            confirmationMessage.textContent = message;
            currentConfirmAction = onConfirmCallback;
            openModal(confirmationModal);
        }

        // Copy to clipboard function
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard!', 'success');
            } catch (err) {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy to clipboard.', 'error');
            }
            document.body.removeChild(textarea);
        }

        // --- Initial Authentication Check and Dashboard Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }

            // Verify token by trying to fetch bot status
            const initialCheck = await fetchWithAuth(`${API_BASE_URL}/api/admin/bot-status`);
            if (!initialCheck) {
                // fetchWithAuth already handles redirection if token is invalid
                return;
            }

            // If token is valid, proceed with dashboard initialization
            setupSocketIO();
            renderSection('bot-status'); // Default active section
        });

        // --- Socket.IO Setup ---
        let socket;
        function setupSocketIO() {
            socket = io(SOCKET_IO_URL);

            socket.on('connect', () => {
                console.log('Connected to Socket.IO');
                showToast('Connected to real-time updates!', 'success');
            });

            socket.on('connect_error', (error) => {
                console.error('Socket.IO connection error:', error);
                showToast('Socket.IO connection error. Real-time updates may be affected.', 'error');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from Socket.IO');
                showToast('Disconnected from real-time updates. Some features may not be live.', 'warning');
            });

            socket.on('status', (status) => {
                console.log('Bot Status:', status);
                updateBotStatusUI(status);
            });

            socket.on('qrCode', (qrCode) => {
                console.log('QR Code Received:', qrCode ? 'Yes' : 'No');
                if (qrCode) {
                    qrCodeDisplay.src = qrCode;
                    qrCodeDisplay.style.display = 'block';
                    qrCodeMessage.textContent = 'Scan this QR code with your WhatsApp app.';
                } else {
                    qrCodeDisplay.src = '';
                    qrCodeDisplay.style.display = 'none';
                    qrCodeMessage.textContent = 'No QR code available.';
                }
            });

            socket.on('sessionInfo', (info) => {
                console.log('Session Info:', info);
                if (info && info.lastAuthenticatedAt) {
                    lastAuthenticatedAtSpan.textContent = new Date(info.lastAuthenticatedAt).toLocaleString();
                } else {
                    lastAuthenticatedAtSpan.textContent = 'N/A';
                }
            });

            socket.on('whatsapp_log', (logMessage) => {
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${logMessage}`;
                whatsappLogs.appendChild(logEntry);
                whatsappLogs.scrollTop = whatsappLogs.scrollHeight; // Auto-scroll to bottom
            });

            socket.on('new_order', (order) => {
                showToast(`New Order Received! ID: ${order.customOrderId}`, 'info');
                if (document.getElementById('order-management').classList.contains('active')) {
                    loadOrders(); // Refresh orders table if active
                }
            });
        }

        // --- Navigation ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionName = link.dataset.section;
                renderSection(sectionName);

                // Update active class
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        async function renderSection(sectionName) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');
            currentSectionTitle.textContent = sectionName.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            // Load data specific to the section when it becomes active
            switch (sectionName) {
                case 'bot-status':
                    await loadBotStatus();
                    break;
                case 'menu-management':
                    await loadMenuItems();
                    break;
                case 'order-management':
                    await loadOrders();
                    break;
                case 'customer-management':
                    await loadCustomers();
                    break;
                case 'settings':
                    await loadSettings();
                    break;
                case '2fa-management':
                    await load2FAStatus();
                    break;
            }
        }

        // --- Logout ---
        logoutBtn.addEventListener('click', () => {
            showConfirmDialog('Are you sure you want to log out?', () => {
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
            });
        });

        // --- Modals Event Listeners ---
        document.querySelectorAll('.close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modalId;
                closeModal(document.getElementById(modalId));
            });
        });

        document.querySelectorAll('.modal .btn-secondary[data-modal-id]').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modalId;
                closeModal(document.getElementById(modalId));
            });
        });

        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                closeModal(confirmationModal);
            }
        });

        confirmActionButton.addEventListener('click', () => {
            if (currentConfirmAction) {
                currentConfirmAction();
            }
            closeModal(confirmationModal);
            currentConfirmAction = null; // Reset
        });

        // Close modals if clicking outside content
        [menuItemModal, orderDetailsModal, customerLatestOrderModal, twoFaGenerateModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal);
                }
            });
        });

        // --- Section Specific Functions ---

        // WhatsApp Bot Status
        async function loadBotStatus() {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/bot-status`);
            if (response) {
                const data = await response.json();
                updateBotStatusUI(data.status);
                if (data.lastAuthenticatedAt) {
                    lastAuthenticatedAtSpan.textContent = new Date(data.lastAuthenticatedAt).toLocaleString();
                } else {
                    lastAuthenticatedAtSpan.textContent = 'N/A';
                }
                if (data.qrCodeAvailable && data.status === 'qr_received') {
                    // Request QR code explicitly if available and status is qr_received
                    // Backend will emit it via socket.io
                    showToast('QR code is available. Please scan.', 'info');
                } else {
                    qrCodeDisplay.src = '';
                    qrCodeDisplay.style.display = 'none';
                    qrCodeMessage.textContent = 'No QR code available.';
                }
            }
        }

        function updateBotStatusUI(status) {
            botStatusText.textContent = status.replace(/_/g, ' ').toUpperCase();
            botStatusText.className = `status-indicator ${status}`; // Apply status class

            // Update icon color based on status
            switch (status) {
                case 'disconnected':
                case 'auth_failure':
                case 'qr_error':
                    botStatusIcon.style.color = 'var(--error-red)';
                    break;
                case 'qr_received':
                    botStatusIcon.style.color = 'var(--warning-orange)';
                    break;
                case 'authenticated':
                case 'initializing':
                    botStatusIcon.style.color = 'var(--accent-blue)';
                    break;
                case 'ready':
                    botStatusIcon.style.color = 'var(--success-green)';
                    break;
                default:
                    botStatusIcon.style.color = 'var(--text-light)';
            }
        }

        forceNewSessionBtn.addEventListener('click', async () => {
            showConfirmDialog('This will disconnect the current WhatsApp session and generate a new QR code. Are you sure?', async () => {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/load-session`, { method: 'POST' });
                if (response) {
                    showToast('WhatsApp session re-initialization requested. Please wait for QR code.', 'info');
                }
            });
        });

        // Menu Management
        async function loadMenuItems() {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/menu`);
            if (response) {
                const items = await response.json();
                menuItemsTableBody.innerHTML = '';
                if (items.length === 0) {
                    menuItemsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No menu items found. Add some!</td></tr>';
                    return;
                }
                items.forEach(item => {
                    const row = menuItemsTableBody.insertRow();
                    row.innerHTML = `
                        <td><img src="${item.imageUrl || 'https://placehold.co/50x50/E0E0E0/666666?text=No+Img'}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" onerror="this.onerror=null;this.src='https://placehold.co/50x50/E0E0E0/666666?text=No+Img';"></td>
                        <td>${item.name}</td>
                        <td>${item.description || '-'}</td>
                        <td>₹${item.price.toFixed(2)}</td>
                        <td>${item.category || '-'}</td>
                        <td>${item.isAvailable ? '<i class="fas fa-check-circle" style="color: var(--success-green);"></i>' : '<i class="fas fa-times-circle" style="color: var(--error-red);"></i>'}</td>
                        <td>${item.isTrending ? '<i class="fas fa-fire" style="color: var(--warning-orange);"></i>' : '-'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="editMenuItem('${item._id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMenuItem('${item._id}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                });
            }
        }

        addMenuItemBtn.addEventListener('click', () => {
            menuItemModalTitle.textContent = 'Add New Menu Item';
            menuItemId.value = '';
            menuItemForm.reset(); // Clear form
            isAvailable.checked = true; // Default to available
            isTrending.checked = false;
            openModal(menuItemModal);
        });

        async function editMenuItem(id) {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/menu/${id}`);
            if (response) {
                const item = await response.json();
                menuItemModalTitle.textContent = 'Edit Menu Item';
                menuItemId.value = item._id;
                itemName.value = item.name;
                itemDescription.value = item.description || '';
                itemPrice.value = item.price;
                itemImageUrl.value = item.imageUrl || '';
                itemCategory.value = item.category || '';
                isAvailable.checked = item.isAvailable;
                isTrending.checked = item.isTrending;
                openModal(menuItemModal);
            }
        }

        menuItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = menuItemId.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE_URL}/api/admin/menu/${id}` : `${API_BASE_URL}/api/admin/menu`;

            const itemData = {
                name: itemName.value,
                description: itemDescription.value,
                price: parseFloat(itemPrice.value),
                imageUrl: itemImageUrl.value,
                category: itemCategory.value,
                isAvailable: isAvailable.checked,
                isTrending: isTrending.checked
            };

            const response = await fetchWithAuth(url, {
                method: method,
                body: JSON.stringify(itemData)
            });

            if (response) {
                showToast(`Item ${id ? 'updated' : 'added'} successfully!`, 'success');
                closeModal(menuItemModal);
                loadMenuItems();
            }
        });

        function deleteMenuItem(id) {
            showConfirmDialog('Are you sure you want to delete this menu item?', async () => {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/menu/${id}`, { method: 'DELETE' });
                if (response) {
                    showToast('Menu item deleted successfully!', 'success');
                    loadMenuItems();
                }
            });
        }

        // Order Management
        async function loadOrders() {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/orders`);
            if (response) {
                const orders = await response.json();
                ordersTableBody.innerHTML = '';
                if (orders.length === 0) {
                    ordersTableBody.innerHTML = '<tr><td colspan="11" style="text-align: center;">No orders found.</td></tr>';
                    return;
                }
                orders.forEach(order => {
                    const row = ordersTableBody.insertRow();
                    const orderItems = order.items.map(item => `${item.name} x ${item.quantity}`).join(', ');
                    const orderDate = new Date(order.orderDate).toLocaleString();

                    row.innerHTML = `
                        <td>${order.customOrderId || order._id.substring(0, 6) + '...'}</td>
                        <td>${order.pinId || 'N/A'}</td>
                        <td>${order.customerName || 'Unknown'}</td>
                        <td>${order.customerPhone}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${orderItems}">${orderItems}</td>
                        <td>₹${order.totalAmount.toFixed(2)}</td>
                        <td>
                            <select onchange="updateOrderStatus('${order._id}', this.value)" class="form-group-select">
                                <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                                <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                                <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </td>
                        <td>${order.paymentMethod}</td>
                        <td>${orderDate}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${order.deliveryAddress}">${order.deliveryAddress || 'N/A'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="viewOrderDetails('${order._id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteOrder('${order._id}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                });
            }
        }

        async function updateOrderStatus(id, newStatus) {
            showConfirmDialog(`Change status of order ${id.substring(0, 6)}... to "${newStatus}"?`, async () => {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/orders/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });
                if (response) {
                    showToast('Order status updated successfully!', 'success');
                    loadOrders();
                }
            });
        }

        async function viewOrderDetails(id) {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/orders/${id}`);
            if (response) {
                const order = await response.json();
                let content = `
                    <p><strong>Order ID:</strong> ${order.customOrderId || order._id}</p>
                    <p><strong>PIN:</strong> ${order.pinId || 'N/A'}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName || 'Unknown'}</p>
                    <p><strong>Customer Phone:</strong> ${order.customerPhone}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                    <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
                    ${order.customerLocation && order.customerLocation.latitude && order.customerLocation.longitude ? `<p><strong>Customer Location:</strong> Lat: ${order.customerLocation.latitude}, Lng: ${order.customerLocation.longitude} (${order.customerLocation.address || 'N/A'})</p>` : ''}
                    <h4>Items:</h4>
                    <ul>
                `;
                order.items.forEach(item => {
                    content += `<li>${item.name} x ${item.quantity} (₹${item.price.toFixed(2)} each)</li>`;
                });
                content += `</ul>
                    <p><strong>Subtotal:</strong> ₹${order.subtotal.toFixed(2)}</p>
                    <p><strong>Transport Tax:</strong> ₹${order.transportTax.toFixed(2)}</p>
                    ${order.discountAmount > 0 ? `<p><strong>Discount:</strong> -₹${order.discountAmount.toFixed(2)}</p>` : ''}
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                `;
                orderDetailsContent.innerHTML = content;
                openModal(orderDetailsModal);
            }
        }

        function deleteOrder(id) {
            showConfirmDialog('Are you sure you want to delete this order? This action cannot be undone.', async () => {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/orders/${id}`, { method: 'DELETE' });
                if (response) {
                    showToast('Order deleted successfully!', 'success');
                    loadOrders();
                }
            });
        }

        // Customer Management
        async function loadCustomers() {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/customers`);
            if (response) {
                const customers = await response.json();
                customersTableBody.innerHTML = '';
                if (customers.length === 0) {
                    customersTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No customers found.</td></tr>';
                    return;
                }
                customers.forEach(customer => {
                    const row = customersTableBody.insertRow();
                    const lastOrderDate = customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleDateString() : 'N/A';
                    const lastKnownLocation = customer.lastKnownLocation && (customer.lastKnownLocation.address || (customer.lastKnownLocation.latitude && customer.lastKnownLocation.longitude)) ? `${customer.lastKnownLocation.address || `Lat: ${customer.lastKnownLocation.latitude}, Lng: ${customer.lastKnownLocation.longitude}`}` : 'N/A';

                    row.innerHTML = `
                        <td>${customer.customerName || 'Unknown'}</td>
                        <td>${customer.customerPhone}</td>
                        <td>${customer.totalOrders}</td>
                        <td>${lastOrderDate}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${lastKnownLocation}">${lastKnownLocation}">
                            ${lastKnownLocation}
                        </td>
                        <td class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="viewCustomerLatestOrder('${customer.customerPhone}', '${customer.customerName || 'Unknown'}')"><i class="fas fa-history"></i> Latest Order</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer._id}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                });
            }
        }

        async function viewCustomerLatestOrder(phone, name) {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/customers/${phone}/latest-order`);
            customerLatestOrderName.textContent = name; // Always set name
            if (response) {
                const order = await response.json();
                let content = `
                    <p><strong>Order ID:</strong> ${order.customOrderId || order._id}</p>
                    <p><strong>PIN:</strong> ${order.pinId || 'N/A'}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <h4>Items:</h4>
                    <ul>
                `;
                order.items.forEach(item => {
                    content += `<li>${item.name} x ${item.quantity}</li>`;
                });
                content += `</ul>`;
                customerLatestOrderContent.innerHTML = content;
                openModal(customerLatestOrderModal);
            } else {
                customerLatestOrderContent.innerHTML = '<p>No latest order found for this customer.</p>';
                openModal(customerLatestOrderModal);
            }
        }

        function deleteCustomer(id) {
            showConfirmDialog('Are you sure you want to delete this customer record? This will not delete their orders.', async () => {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/customers/${id}`, { method: 'DELETE' });
                if (response) {
                    showToast('Customer deleted successfully!', 'success');
                    loadCustomers();
                }
            });
        }

        // Settings
        async function loadSettings() {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/settings`);
            if (response) {
                const settings = await response.json();
                shopNameInput.value = settings.shopName || '';
                shopLocationLatitudeInput.value = settings.shopLocation ? settings.shopLocation.latitude : '';
                shopLocationLongitudeInput.value = settings.shopLocation ? settings.shopLocation.longitude : '';
                minSubtotalForDiscountInput.value = settings.minSubtotalForDiscount || 0;
                discountPercentageInput.value = settings.discountPercentage || 0;

                deliveryRatesContainer.innerHTML = ''; // Clear existing
                if (settings.deliveryRates && settings.deliveryRates.length > 0) {
                    settings.deliveryRates.forEach(rate => addDeliveryRateRow(rate.kms, rate.amount));
                } else {
                    addDeliveryRateRow(); // Add an empty one if none exist
                }
            }
        }

        function addDeliveryRateRow(kms = '', amount = '') {
            const div = document.createElement('div');
            div.classList.add('delivery-rate-item');
            div.innerHTML = `
                <div class="form-group">
                    <label>KMs</label>
                    <input type="number" class="delivery-kms" value="${kms}" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Amount (₹)</label>
                    <input type="number" class="delivery-amount" value="${amount}" step="0.01" min="0" required>
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-delivery-rate-btn"><i class="fas fa-minus-circle"></i></button>
            `;
            deliveryRatesContainer.appendChild(div);

            div.querySelector('.remove-delivery-rate-btn').addEventListener('click', () => {
                div.remove();
            });
        }

        addDeliveryRateBtn.addEventListener('click', () => addDeliveryRateRow());

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const deliveryRates = [];
            document.querySelectorAll('.delivery-rate-item').forEach(item => {
                const kms = parseFloat(item.querySelector('.delivery-kms').value);
                const amount = parseFloat(item.querySelector('.delivery-amount').value);
                if (!isNaN(kms) && !isNaN(amount)) {
                    deliveryRates.push({ kms, amount });
                }
            });

            const settingsData = {
                shopName: shopNameInput.value,
                shopLocation: {
                    latitude: parseFloat(shopLocationLatitudeInput.value),
                    longitude: parseFloat(shopLocationLongitudeInput.value)
                },
                deliveryRates: deliveryRates,
                minSubtotalForDiscount: parseFloat(minSubtotalForDiscountInput.value),
                discountPercentage: parseFloat(discountPercentageInput.value)
            };

            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/settings`, {
                method: 'PUT',
                body: JSON.stringify(settingsData)
            });

            if (response) {
                showToast('Settings updated successfully!', 'success');
                loadSettings(); // Reload to ensure consistent state
            }
        });

        // 2FA Management
        async function load2FAStatus() {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/2fa/status`);
            if (response) {
                const data = await response.json();
                if (data.twoFactorEnabled) {
                    twoFaStatusText.textContent = 'Enabled';
                    twoFaStatusText.style.color = 'var(--success-green)';
                    enable2FABtn.style.display = 'none';
                    disable2FABtn.style.display = 'inline-block';
                } else {
                    twoFaStatusText.textContent = 'Disabled';
                    twoFaStatusText.style.color = 'var(--error-red)';
                    enable2FABtn.style.display = 'inline-block';
                    disable2FABtn.style.display = 'none';
                }
            }
        }

        enable2FABtn.addEventListener('click', async () => {
            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/2fa/generate`, { method: 'POST' });
            if (response) {
                const data = await response.json();
                qrCode2FADisplay.src = data.qrCodeUrl;
                totpSecretText.textContent = data.secret;
                temp2FASecret = data.secret; // Store for verification
                totpCodeVerify.value = ''; // Clear input
                openModal(twoFaGenerateModal);
            }
        });

        verify2FABtn.addEventListener('click', async () => {
            const totpCode = totpCodeVerify.value;
            if (!totpCode || totpCode.length !== 6 || isNaN(totpCode)) {
                showToast('Please enter a valid 6-digit code.', 'error');
                return;
            }

            if (!temp2FASecret) {
                showToast('2FA secret is missing. Please regenerate QR.', 'error');
                return;
            }

            const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/2fa/verify`, {
                method: 'POST',
                body: JSON.stringify({ totpCode: totpCode, secret: temp2FASecret })
            });

            if (response) {
                const data = await response.json();
                if (data.verified) {
                    showToast('2FA successfully enabled!', 'success');
                    closeModal(twoFaGenerateModal);
                    load2FAStatus(); // Refresh status
                    temp2FASecret = null; // Clear temporary secret
                } else {
                    showToast(data.message || 'Invalid 2FA code. Please try again.', 'error');
                }
            }
        });

        disable2FABtn.addEventListener('click', () => {
            showConfirmDialog('Are you sure you want to disable Two-Factor Authentication? This will reduce your account security.', async () => {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/2fa/disable`, { method: 'POST' });
                if (response) {
                    showToast('2FA disabled successfully!', 'success');
                    load2FAStatus(); // Refresh status
                }
            });
        });
    </script>
</body>
</html>

