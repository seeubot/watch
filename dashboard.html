<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delicious Bites</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Poppins for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5; /* Lighter background */
            min-height: 100vh;
            display: flex;
        }
        /* Sidebar styling */
        aside {
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            border-right: 1px solid #e2e8f0;
        }
        .sidebar-link {
            @apply flex items-center p-3 text-gray-700 rounded-lg transition-colors duration-200;
        }
        .sidebar-link:hover {
            background-color: #e0e7ff; /* Light indigo hover */
            color: #4f46e5; /* Darker indigo text */
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* Primary indigo for active */
            color: white;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
        }
        .sidebar-link.active svg, .sidebar-link.active i {
            color: white;
        }
        .sidebar-link svg, .sidebar-link i {
            color: #6b7280; /* Default icon color */
            transition: color 0.2s ease-in-out;
        }

        /* Main content header */
        header {
            background-color: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Card styling */
        .card {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        /* Table styling */
        .table-container {
            overflow-x: auto; /* Enable horizontal scrolling for tables on small screens */
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        .table-header th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap; /* Prevent wrapping */
        }
        .table-row td {
            padding: 1rem 1.25rem;
            font-size: 0.9rem;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap; /* Prevent wrapping */
        }
        .table-row:last-child td {
            border-bottom: none;
        }
        .table-row:hover {
            background-color: #f3f4f6;
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; } /* yellow */
        .status-confirmed { background-color: #dbeafe; color: #1e40af; } /* blue */
        .status-preparing { background-color: #bfdbfe; color: #1d4ed8; } /* light blue */
        .status-out-for-delivery { background-color: #d1fae5; color: #065f46; } /* green */
        .status-delivered { background-color: #dcfce7; color: #16a34a; } /* dark green */
        .status-cancelled { background-color: #fee2e2; color: #dc2626; } /* red */

        /* WhatsApp Bot Status */
        .status-ready { background-color: #dcfce7; color: #16a34a; }
        .status-qr_received { background-color: #fef3c7; color: #92400e; }
        .status-authenticated { background-color: #dbeafe; color: #1e40af; }
        .status-disconnected { background-color: #fee2e2; color: #dc2626; }
        .status-auth_failure { background-color: #fee2e2; color: #dc2626; }
        .status-initializing { background-color: #e0e7ff; color: #4f46e5; }
        .status-qr_error { background-color: #fee2e2; color: #dc2626; }


        /* General button styling */
        .btn {
            @apply px-4 py-2 rounded-lg font-medium transition duration-200 ease-in-out transform hover:scale-105;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 shadow-sm;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 shadow-sm;
        }
        .btn-info {
            @apply bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 shadow-sm;
        }
        .input-field {
            @apply mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-base;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }

        /* Modal styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 5xl; /* Increased max-width for modals */
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Log area custom scrollbar */
        .log-area::-webkit-scrollbar {
            width: 8px;
            border-radius: 10px;
        }
        .log-area::-webkit-scrollbar-track {
            background: #2d3748; /* Darker track for dark log background */
            border-radius: 10px;
        }
        .log-area::-webkit-scrollbar-thumb {
            background: #4a5568; /* Slightly lighter thumb */
            border-radius: 10px;
        }
        .log-area::-webkit-scrollbar-thumb:hover {
            background: #606f80;
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg p-6 flex flex-col">
        <div class="text-2xl font-bold text-indigo-600 mb-8">Delicious Bites</div>
        <nav class="flex-grow">
            <ul class="space-y-2">
                <li>
                    <a href="#dashboard" class="sidebar-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt mr-3 text-xl"></i> Dashboard
                    </a>
                </li>
                <li>
                    <a href="#menu" class="sidebar-link" data-section="menu">
                        <i class="fas fa-hamburger mr-3 text-xl"></i> Menu
                    </a>
                </li>
                <li>
                    <a href="#orders" class="sidebar-link" data-section="orders">
                        <i class="fas fa-clipboard-list mr-3 text-xl"></i> Orders
                    </a>
                </li>
                <li>
                    <a href="#customers" class="sidebar-link" data-section="customers">
                        <i class="fas fa-users mr-3 text-xl"></i> Customers
                    </a>
                </li>
                <li>
                    <a href="#settings" class="sidebar-link" data-section="settings">
                        <i class="fas fa-cog mr-3 text-xl"></i> Settings
                    </a>
                </li>
                <li>
                    <a href="#whatsapp-bot" class="sidebar-link" data-section="whatsapp-bot">
                        <i class="fab fa-whatsapp mr-3 text-xl"></i> WhatsApp Bot
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto pt-4 border-t border-gray-200">
            <button id="logout-button" class="w-full btn btn-secondary flex items-center justify-center">
                <i class="fas fa-sign-out-alt mr-2"></i> Logout
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Header for Main Content -->
        <header class="flex justify-between items-center px-8 py-5">
            <h1 id="page-title" class="text-3xl font-semibold text-gray-800">Dashboard</h1>
            <div class="flex items-center space-x-4">
                <button id="2fa-settings-button" class="btn btn-info">
                    <i class="fas fa-shield-alt mr-2"></i> 2FA Settings
                </button>
                <button id="view-logs-button" class="btn btn-secondary">
                    <i class="fas fa-file-alt mr-2"></i> View Logs
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-1 p-8 overflow-y-auto">
            <!-- Content will be loaded here dynamically -->
            <div id="dashboard-section" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium opacity-90">Total Orders</div>
                            <div id="total-orders-stat" class="text-4xl font-bold mt-1">0</div>
                        </div>
                        <i class="fas fa-shopping-cart text-5xl opacity-30"></i>
                    </div>
                    <div class="card bg-gradient-to-br from-yellow-500 to-yellow-600 text-white flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium opacity-90">Pending Orders</div>
                            <div id="pending-orders-stat" class="text-4xl font-bold mt-1">0</div>
                        </div>
                        <i class="fas fa-hourglass-half text-5xl opacity-30"></i>
                    </div>
                    <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium opacity-90">Delivered Orders</div>
                            <div id="delivered-orders-stat" class="text-4xl font-bold mt-1">0</div>
                        </div>
                        <i class="fas fa-check-circle text-5xl opacity-30"></i>
                    </div>
                    <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium opacity-90">Total Customers</div>
                            <div id="total-customers-stat" class="text-4xl font-bold mt-1">0</div>
                        </div>
                        <i class="fas fa-users text-5xl opacity-30"></i>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Orders</h2>
                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="table-header">
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-recent-orders-table-body">
                                <!-- Recent orders will be loaded here -->
                                <tr><td colspan="7" class="text-center py-4 text-gray-500">No recent orders.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="menu-section" class="hidden space-y-8">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Menu Management</h2>
                        <button id="add-menu-item-button" class="btn btn-primary">
                            <i class="fas fa-plus mr-2"></i> Add New Item
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="table-header">
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th>Available</th>
                                    <th>Trending</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="menu-table-body">
                                <!-- Menu items will be loaded here -->
                                <tr><td colspan="8" class="text-center py-4 text-gray-500">No menu items.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="orders-section" class="hidden space-y-8">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Order Management</h2>
                    <div class="mb-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                        <select id="order-status-filter" class="input-field sm:w-48">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Preparing">Preparing</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <input type="text" id="order-search" placeholder="Search by Order ID or Customer Phone" class="input-field flex-grow">
                        <button id="apply-order-filter" class="btn btn-primary">Apply Filter</button>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="table-header">
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Payment</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <!-- Orders will be loaded here -->
                                <tr><td colspan="9" class="text-center py-4 text-gray-500">No orders.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="customers-section" class="hidden space-y-8">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Customer Management</h2>
                    <div class="mb-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="customer-search" placeholder="Search by Phone or Name" class="input-field flex-grow">
                        <button id="apply-customer-filter" class="btn btn-primary">Apply Filter</button>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="table-header">
                                    <th>Phone</th>
                                    <th>Name</th>
                                    <th>Total Orders</th>
                                    <th>Last Order Date</th>
                                    <th>Last Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customers-table-body">
                                <!-- Customers will be loaded here -->
                                <tr><td colspan="6" class="text-center py-4 text-gray-500">No customers.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings-section" class="hidden space-y-8">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">General Settings</h2>
                    <form id="general-settings-form" class="space-y-4">
                        <div>
                            <label for="shop-name" class="form-label">Shop Name</label>
                            <input type="text" id="shop-name" name="shopName" class="input-field" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="shop-latitude" class="form-label">Shop Location Latitude</label>
                                <input type="number" step="0.000001" id="shop-latitude" name="shopLocation.latitude" class="input-field" required>
                            </div>
                            <div>
                                <label for="shop-longitude" class="form-label">Shop Location Longitude</label>
                                <input type="number" step="0.000001" id="shop-longitude" name="shopLocation.longitude" class="input-field" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save General Settings</button>
                    </form>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Delivery Rates</h2>
                    <div id="delivery-rates-container" class="space-y-4">
                        <!-- Delivery rate inputs will be added here -->
                    </div>
                    <div class="flex space-x-3 mt-4">
                        <button id="add-delivery-rate-button" class="btn btn-secondary">
                            <i class="fas fa-plus mr-2"></i> Add Delivery Rate
                        </button>
                        <button id="save-delivery-rates-button" class="btn btn-primary">Save Delivery Rates</button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Discount Settings</h2>
                    <form id="discount-settings-form" class="space-y-4">
                        <div>
                            <label for="min-subtotal-discount" class="form-label">Minimum Subtotal for Discount (₹)</label>
                            <input type="number" step="0.01" id="min-subtotal-discount" name="minSubtotalForDiscount" class="input-field" required>
                        </div>
                        <div>
                            <label for="discount-percentage" class="form-label">Discount Percentage (0.00 - 1.00)</label>
                            <input type="number" step="0.01" min="0" max="1" id="discount-percentage" name="discountPercentage" class="input-field" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Discount Settings</button>
                    </form>
                </div>
            </div>

            <div id="whatsapp-bot-section" class="hidden space-y-8">
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">WhatsApp Bot Status</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-indigo-50 p-6 rounded-lg shadow-inner flex flex-col justify-between">
                            <div>
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-indigo-800">Connection Status</h3>
                                    <span id="whatsapp-status-badge" class="status-badge">Loading...</span>
                                </div>
                                <p class="text-gray-700">Last Authenticated: <span id="last-authenticated-at" class="font-medium">N/A</span></p>
                            </div>
                            <div class="mt-6">
                                <button id="load-session-button" class="btn btn-primary w-full">
                                    <i class="fas fa-redo mr-2"></i> Load New Session / Get QR
                                </button>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg shadow-inner flex flex-col items-center justify-center">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Scan QR Code</h3>
                            <div id="qr-code-container" class="w-56 h-56 bg-white p-3 rounded-lg shadow-md flex items-center justify-center border border-gray-200">
                                <p id="qr-message" class="text-gray-500 text-center text-sm">QR code will appear here</p>
                                <img id="qr-code-image" src="" alt="QR Code" class="hidden w-full h-full object-contain">
                            </div>
                            <p class="text-sm text-gray-600 mt-3 text-center">Scan this QR code with your WhatsApp app on your phone.</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">WhatsApp Logs</h2>
                    <div id="whatsapp-logs" class="log-area bg-gray-900 text-green-300 p-4 rounded-lg h-80 overflow-y-scroll text-sm font-mono">
                        <!-- Logs will be appended here -->
                        <p class="text-gray-500">Waiting for logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 id="message-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Message</h3>
            <p id="message-modal-content" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="message-modal-close" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- 2FA Settings Modal -->
    <div id="two-factor-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden modal-overlay">
        <div class="modal-content w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Two-Factor Authentication Settings</h3>
            <div id="2fa-status-display" class="mb-6 text-center">
                <p class="text-lg font-medium">Status: <span id="current-2fa-status" class="font-bold">Loading...</span></p>
            </div>

            <div id="2fa-enable-section" class="hidden space-y-5">
                <p class="text-gray-700 text-center">Scan the QR code with your authenticator app (e.g., Google Authenticator) or manually enter the secret key below.</p>
                <div class="flex flex-col items-center justify-center mb-4">
                    <img id="2fa-qr-code" src="" alt="2FA QR Code" class="w-56 h-56 border border-gray-300 p-3 rounded-lg shadow-inner mb-4">
                    <p class="font-mono text-base text-gray-600 break-all bg-gray-100 p-3 rounded-md select-all" id="2fa-secret-key"></p>
                </div>
                <form id="2fa-verify-form" class="space-y-4">
                    <div>
                        <label for="2fa-code-input" class="form-label">Enter 6-digit Code to Enable</label>
                        <input type="text" id="2fa-code-input" class="input-field text-center text-lg tracking-wider" placeholder="XXXXXX" maxlength="6" inputmode="numeric" pattern="[0-9]*" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Enable 2FA</button>
                </form>
            </div>

            <div id="2fa-disable-section" class="hidden space-y-5">
                <p class="text-gray-700 text-center">Two-Factor Authentication is currently enabled. You can disable it below.</p>
                <button id="disable-2fa-button" class="btn btn-danger w-full">Disable 2FA</button>
            </div>

            <div class="flex justify-end mt-8">
                <button id="close-2fa-modal" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden modal-overlay">
        <div class="modal-content w-full max-w-2xl">
            <h3 class="text-xl font-semibold mb-6 text-gray-800">Order Details</h3>
            <div id="order-details-content" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-gray-700 text-base">
                <p><strong>Order ID:</strong> <span id="modal-order-id"></span></p>
                <p><strong>PIN:</strong> <span id="modal-order-pin"></span></p>
                <p><strong>Customer Name:</strong> <span id="modal-customer-name"></span></p>
                <p><strong>Customer Phone:</strong> <span id="modal-customer-phone"></span></p>
                <p class="md:col-span-2"><strong>Delivery Address:</strong> <span id="modal-delivery-address"></span></p>
                <p class="md:col-span-2"><strong>Customer Location:</strong> <span id="modal-customer-location"></span></p>
                <div class="md:col-span-2">
                    <p class="font-bold mt-2 mb-1">Items:</p>
                    <ul id="modal-order-items" class="list-disc pl-5 space-y-1 text-sm"></ul>
                </div>
                <p><strong>Subtotal:</strong> ₹<span id="modal-subtotal"></span></p>
                <p><strong>Transport Tax:</strong> ₹<span id="modal-transport-tax"></span></p>
                <p><strong>Discount:</strong> ₹<span id="modal-discount-amount"></span></p>
                <p class="font-bold text-lg"><strong>Total Amount:</strong> ₹<span id="modal-total-amount"></span></p>
                <p><strong>Payment Method:</strong> <span id="modal-payment-method"></span></p>
                <p><strong>Status:</strong> <span id="modal-status" class="status-badge"></span></p>
                <p class="md:col-span-2"><strong>Order Date:</strong> <span id="modal-order-date"></span></p>
            </div>
            <div class="flex justify-end mt-8">
                <button id="close-order-details-modal" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Menu Item Modal -->
    <div id="edit-menu-item-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden modal-overlay">
        <div class="modal-content w-full max-w-md">
            <h3 id="edit-modal-title" class="text-xl font-semibold mb-6 text-gray-800">Edit Menu Item</h3>
            <form id="menu-item-form" class="space-y-4">
                <input type="hidden" id="edit-item-id">
                <div>
                    <label for="edit-item-name" class="form-label">Name</label>
                    <input type="text" id="edit-item-name" name="name" class="input-field" required>
                </div>
                <div>
                    <label for="edit-item-description" class="form-label">Description</label>
                    <textarea id="edit-item-description" name="description" class="input-field" rows="3"></textarea>
                </div>
                <div>
                    <label for="edit-item-price" class="form-label">Price</label>
                    <input type="number" step="0.01" id="edit-item-price" name="price" class="input-field" required>
                </div>
                <div>
                    <label for="edit-item-image-url" class="form-label">Image URL</label>
                    <input type="url" id="edit-item-image-url" name="imageUrl" class="input-field">
                </div>
                <div>
                    <label for="edit-item-category" class="form-label">Category</label>
                    <input type="text" id="edit-item-category" name="category" class="input-field">
                </div>
                <div class="flex items-center mt-4">
                    <input type="checkbox" id="edit-item-is-available" name="isAvailable" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="edit-item-is-available" class="ml-2 block text-base text-gray-900">Is Available</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="edit-item-is-trending" name="isTrending" class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="edit-item-is-trending" class="ml-2 block text-base text-gray-900">Is Trending</label>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-edit-item" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Socket.io CDN -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const contentSections = document.querySelectorAll('#content-area > div');
            const pageTitle = document.getElementById('page-title');
            const logoutButton = document.getElementById('logout-button');
            const twoFactorSettingsButton = document.getElementById('2fa-settings-button');
            const viewLogsButton = document.getElementById('view-logs-button');

            // Modals
            const messageModal = document.getElementById('message-modal');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalContent = document.getElementById('message-modal-content');
            const messageModalCloseButton = document.getElementById('message-modal-close');

            const twoFactorModal = document.getElementById('two-factor-modal');
            const current2faStatus = document.getElementById('current-2fa-status');
            const enable2faSection = document.getElementById('2fa-enable-section');
            const disable2faSection = document.getElementById('2fa-disable-section');
            const twoFaQrCode = document.getElementById('2fa-qr-code');
            const twoFaSecretKey = document.getElementById('2fa-secret-key');
            const twoFaVerifyForm = document.getElementById('2fa-verify-form');
            const twoFaCodeInput = document.getElementById('2fa-code-input');
            const disable2faButton = document.getElementById('disable-2fa-button');
            const close2faModalButton = document.getElementById('close-2fa-modal');

            const orderDetailsModal = document.getElementById('order-details-modal');
            const closeOrderDetailsModalButton = document.getElementById('close-order-details-modal');

            const editMenuItemModal = document.getElementById('edit-menu-item-modal');
            const editModalTitle = document.getElementById('edit-modal-title');
            const menuItemForm = document.getElementById('menu-item-form');
            const editItemId = document.getElementById('edit-item-id');
            const editItemName = document.getElementById('edit-item-name');
            const editItemDescription = document.getElementById('edit-item-description');
            const editItemPrice = document.getElementById('edit-item-price');
            const editItemImageUrl = document.getElementById('edit-item-image-url');
            const editItemCategory = document.getElementById('edit-item-category');
            const editItemIsAvailable = document.getElementById('edit-item-is-available');
            const editItemIsTrending = document.getElementById('edit-item-is-trending');
            const cancelEditItemButton = document.getElementById('cancel-edit-item');

            // WhatsApp Bot Elements
            const whatsappStatusBadge = document.getElementById('whatsapp-status-badge');
            const lastAuthenticatedAt = document.getElementById('last-authenticated-at');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const qrCodeImage = document.getElementById('qr-code-image');
            const qrMessage = document.getElementById('qr-message');
            const loadSessionButton = document.getElementById('load-session-button');
            const whatsappLogs = document.getElementById('whatsapp-logs');

            // Settings Elements
            const generalSettingsForm = document.getElementById('general-settings-form');
            const shopNameInput = document.getElementById('shop-name');
            const shopLatitudeInput = document.getElementById('shop-latitude');
            const shopLongitudeInput = document.getElementById('shop-longitude');
            const deliveryRatesContainer = document.getElementById('delivery-rates-container');
            const addDeliveryRateButton = document.getElementById('add-delivery-rate-button');
            const saveDeliveryRatesButton = document.getElementById('save-delivery-rates-button');
            const discountSettingsForm = document.getElementById('discount-settings-form');
            const minSubtotalDiscountInput = document.getElementById('min-subtotal-discount');
            const discountPercentageInput = document.getElementById('discount-percentage');


            let current2faSecret = null; // Temporarily holds the generated secret for verification

            // --- Utility Functions ---
            function showMessageModal(title, content) {
                messageModalTitle.textContent = title;
                messageModalContent.textContent = content;
                messageModal.classList.remove('hidden');
            }

            function hideMessageModal() {
                messageModal.classList.add('hidden');
            }

            messageModalCloseButton.addEventListener('click', hideMessageModal);

            function formatTimestamp(timestamp) {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle: 'medium', timeStyle: 'short' });
            }

            function getStatusBadgeClass(status) {
                switch (status) {
                    case 'Pending': return 'status-pending';
                    case 'Confirmed': return 'status-confirmed';
                    case 'Preparing': return 'status-preparing';
                    case 'Out for Delivery': return 'status-out-for-delivery';
                    case 'Delivered': return 'status-delivered';
                    case 'Cancelled': return 'status-cancelled';
                    case 'ready': return 'status-ready';
                    case 'qr_received': return 'status-qr_received';
                    case 'authenticated': return 'status-authenticated';
                    case 'disconnected': return 'status-disconnected';
                    case 'auth_failure': return 'status-auth_failure';
                    case 'initializing': return 'status-initializing';
                    case 'qr_error': return 'status-qr_error';
                    default: return 'bg-gray-200 text-gray-800';
                }
            }

            // --- Authentication Check ---
            async function checkAuth() {
                const token = localStorage.getItem('jwtToken');
                if (!token) {
                    window.location.href = '/admin/login';
                    return false;
                }

                try {
                    // Make a lightweight authenticated API call to verify token
                    const response = await fetch('/api/admin/bot-status', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('jwtToken');
                        window.location.href = '/admin/login';
                        return false;
                    }
                    if (!response.ok) {
                        throw new Error('Authentication check failed.');
                    }
                    return true;
                } catch (error) {
                    console.error('Authentication check error:', error);
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/admin/login';
                    return false;
                }
            }

            // --- Navigation and Section Switching ---
            function showSection(sectionId) {
                contentSections.forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById(sectionId).classList.remove('hidden');
                pageTitle.textContent = sectionId.replace('-section', '').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

                sidebarLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.section + '-section' === sectionId) {
                        link.classList.add('active');
                    }
                });

                // Load data for the active section
                switch (sectionId) {
                    case 'dashboard-section':
                        fetchDashboardStats();
                        fetchRecentOrders();
                        break;
                    case 'menu-section':
                        fetchMenuItems();
                        break;
                    case 'orders-section':
                        fetchOrders();
                        break;
                    case 'customers-section':
                        fetchCustomers();
                        break;
                    case 'settings-section':
                        fetchSettings();
                        fetchDiscountSettings();
                        break;
                    case 'whatsapp-bot-section':
                        fetchWhatsappStatus();
                        break;
                }
            }

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.dataset.section + '-section';
                    window.location.hash = link.dataset.section;
                    showSection(sectionId);
                });
            });

            // Handle initial hash or default to dashboard
            if (window.location.hash) {
                const initialSection = window.location.hash.substring(1);
                showSection(initialSection + '-section');
            } else {
                showSection('dashboard-section');
            }

            // --- Logout ---
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
            });

            // --- Modals Event Listeners ---
            twoFactorSettingsButton.addEventListener('click', async () => {
                twoFactorModal.classList.remove('hidden');
                await fetch2faStatus();
            });

            close2faModalButton.addEventListener('click', () => {
                twoFactorModal.classList.add('hidden');
                // Reset sections
                enable2faSection.classList.add('hidden');
                disable2faSection.classList.add('hidden');
                twoFaQrCode.classList.add('hidden');
                twoFaQrCode.src = '';
                twoFaSecretKey.textContent = '';
                twoFaCodeInput.value = '';
                current2faSecret = null;
            });

            closeOrderDetailsModalButton.addEventListener('click', () => {
                orderDetailsModal.classList.add('hidden');
            });

            cancelEditItemButton.addEventListener('click', () => {
                editMenuItemModal.classList.add('hidden');
                menuItemForm.reset();
            });

            // --- 2FA Logic ---
            async function fetch2faStatus() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/2fa/status', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();

                    enable2faSection.classList.add('hidden');
                    disable2faSection.classList.add('hidden');
                    twoFaQrCode.classList.add('hidden');
                    twoFaQrCode.src = '';
                    twoFaSecretKey.textContent = '';
                    twoFaCodeInput.value = '';
                    current2faSecret = null;

                    if (data.twoFactorEnabled) {
                        current2faStatus.textContent = 'Enabled';
                        current2faStatus.classList.remove('text-red-600', 'text-yellow-600');
                        current2faStatus.classList.add('text-green-600');
                        disable2faSection.classList.remove('hidden');
                    } else {
                        current2faStatus.textContent = 'Disabled';
                        current2faStatus.classList.remove('text-green-600', 'text-yellow-600');
                        current2faStatus.classList.add('text-red-600');
                        enable2faSection.classList.remove('hidden');
                        await generate2faQrCode(); // Generate QR if 2FA is disabled
                    }
                } catch (error) {
                    console.error('Error fetching 2FA status:', error);
                    showMessageModal('Error', 'Failed to fetch 2FA status.');
                }
            }

            async function generate2faQrCode() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/2fa/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        twoFaQrCode.src = data.qrCodeUrl;
                        twoFaQrCode.classList.remove('hidden');
                        twoFaSecretKey.textContent = data.secret;
                        current2faSecret = data.secret; // Store the secret temporarily
                    } else {
                        showMessageModal('Error', data.message || 'Failed to generate 2FA QR code.');
                    }
                } catch (error) {
                    console.error('Error generating 2FA secret:', error);
                    showMessageModal('Error', 'Failed to generate 2FA secret.');
                }
            }

            twoFaVerifyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const totpCode = twoFaCodeInput.value;
                if (!totpCode || totpCode.length !== 6) {
                    showMessageModal('Error', 'Please enter a valid 6-digit code.');
                    return;
                }
                if (!current2faSecret) {
                    showMessageModal('Error', 'No 2FA secret available. Please regenerate QR.');
                    return;
                }

                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/2fa/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ totpCode, secret: current2faSecret })
                    });
                    const data = await response.json();
                    if (response.ok && data.verified) {
                        showMessageModal('Success', '2FA enabled successfully!');
                        twoFactorModal.classList.add('hidden');
                        fetch2faStatus(); // Refresh status
                    } else {
                        showMessageModal('Error', data.message || 'Invalid 2FA code.');
                    }
                } catch (error) {
                    console.error('Error verifying 2FA code:', error);
                    showMessageModal('Error', 'Failed to verify 2FA code.');
                }
            });

            disable2faButton.addEventListener('click', async () => {
                if (confirm('Are you sure you want to disable Two-Factor Authentication?')) {
                    try {
                        const token = localStorage.getItem('jwtToken');
                        const response = await fetch('/api/admin/2fa/disable', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        const data = await response.json();
                        if (response.ok) {
                            showMessageModal('Success', data.message);
                            twoFactorModal.classList.add('hidden');
                            fetch2faStatus(); // Refresh status
                        } else {
                            showMessageModal('Error', data.message || 'Failed to disable 2FA.');
                        }
                    } catch (error) {
                        console.error('Error disabling 2FA:', error);
                        showMessageModal('Error', 'Failed to disable 2FA.');
                    }
                }
            });

            // --- WhatsApp Bot Logic ---
            const socket = io();

            socket.on('status', (status) => {
                console.log('Socket: WhatsApp Status received:', status);
                whatsappStatusBadge.textContent = status.replace('_', ' ').toUpperCase();
                whatsappStatusBadge.className = `status-badge ${getStatusBadgeClass(status)}`;
                if (status === 'qr_received') {
                    qrMessage.textContent = 'Please scan the QR code above.';
                    qrCodeImage.classList.remove('hidden');
                } else if (status === 'ready') {
                    qrMessage.textContent = 'WhatsApp client is connected!';
                    qrCodeImage.classList.add('hidden');
                    qrCodeImage.src = '';
                } else {
                    qrMessage.textContent = 'QR code will appear here';
                    qrCodeImage.classList.add('hidden');
                    qrCodeImage.src = '';
                }
            });

            socket.on('qrCode', (qrData) => {
                console.log('Socket: QR Code received.');
                if (qrData) {
                    qrCodeImage.src = qrData;
                    qrCodeImage.classList.remove('hidden');
                    qrMessage.textContent = 'Scan this QR code.';
                } else {
                    qrCodeImage.src = '';
                    qrCodeImage.classList.add('hidden');
                    qrMessage.textContent = 'QR code will appear here';
                }
            });

            socket.on('sessionInfo', (info) => {
                console.log('Socket: Session Info received:', info);
                lastAuthenticatedAt.textContent = info.lastAuthenticatedAt ? formatTimestamp(info.lastAuthenticatedAt) : 'N/A';
            });

            socket.on('whatsapp_log', (logMessage) => {
                const p = document.createElement('p');
                p.textContent = `[${formatTimestamp(new Date())}] ${logMessage}`;
                whatsappLogs.appendChild(p);
                whatsappLogs.scrollTop = whatsappLogs.scrollHeight; // Auto-scroll to bottom
            });

            socket.on('new_order', (order) => {
                console.log('Socket: New order received:', order);
                showMessageModal('New Order!', `New order received from ${order.customerName} (ID: ${order.customOrderId}). Total: ₹${order.totalAmount.toFixed(2)}`);
                // Refresh orders list if currently on orders section
                if (!document.getElementById('orders-section').classList.contains('hidden')) {
                    fetchOrders();
                }
                // Refresh dashboard stats and recent orders
                if (!document.getElementById('dashboard-section').classList.contains('hidden')) {
                    fetchDashboardStats();
                    fetchRecentOrders();
                }
            });

            loadSessionButton.addEventListener('click', async () => {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/load-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                    } else {
                        showMessageModal('Error', data.message || 'Failed to initiate session load.');
                    }
                } catch (error) {
                    console.error('Error loading session:', error);
                    showMessageModal('Error', 'Failed to load session.');
                }
            });

            viewLogsButton.addEventListener('click', () => {
                // This button now simply navigates to the WhatsApp Bot section
                window.location.hash = 'whatsapp-bot';
                showSection('whatsapp-bot-section');
            });


            async function fetchWhatsappStatus() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/bot-status', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        whatsappStatusBadge.textContent = data.status.replace('_', ' ').toUpperCase();
                        whatsappStatusBadge.className = `status-badge ${getStatusBadgeClass(data.status)}`;
                        lastAuthenticatedAt.textContent = data.lastAuthenticatedAt ? formatTimestamp(data.lastAuthenticatedAt) : 'N/A';
                        if (data.qrCodeAvailable) {
                            qrMessage.textContent = 'QR code is available. Please scan.';
                            // QR image will be populated by socket.io 'qrCode' event
                        } else if (data.status === 'ready') {
                            qrMessage.textContent = 'WhatsApp client is connected!';
                            qrCodeImage.classList.add('hidden');
                        } else {
                            qrCodeImage.src = ''; // Clear image if not available
                            qrCodeImage.classList.add('hidden');
                            qrMessage.textContent = 'QR code will appear here';
                        }
                    } else {
                        showMessageModal('Error', data.message || 'Failed to fetch WhatsApp status.');
                    }
                } catch (error) {
                    console.error('Error fetching WhatsApp status:', error);
                    showMessageModal('Error', 'Failed to fetch WhatsApp status.');
                }
            }

            // --- Dashboard Stats & Recent Orders ---
            async function fetchDashboardStats() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const ordersResponse = await fetch('/api/admin/orders', { headers: { 'Authorization': `Bearer ${token}` } });
                    const customersResponse = await fetch('/api/admin/customers', { headers: { 'Authorization': `Bearer ${token}` } });

                    if (!ordersResponse.ok || !customersResponse.ok) {
                        throw new Error('Failed to fetch dashboard stats.');
                    }

                    const orders = await ordersResponse.json();
                    const customers = await customersResponse.json();

                    document.getElementById('total-orders-stat').textContent = orders.length;
                    document.getElementById('pending-orders-stat').textContent = orders.filter(o => o.status === 'Pending').length;
                    document.getElementById('delivered-orders-stat').textContent = orders.filter(o => o.status === 'Delivered').length;
                    document.getElementById('total-customers-stat').textContent = customers.length;

                } catch (error) {
                    console.error('Error fetching dashboard stats:', error);
                    showMessageModal('Error', 'Failed to load dashboard statistics.');
                }
            }

            async function fetchRecentOrders() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/orders', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch recent orders.');
                    }
                    const orders = await response.json();
                    const recentOrders = orders.slice(0, 5); // Get top 5 recent orders

                    const tableBody = document.getElementById('dashboard-recent-orders-table-body');
                    tableBody.innerHTML = ''; // Clear existing rows

                    if (recentOrders.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No recent orders.</td></tr>';
                        return;
                    }

                    recentOrders.forEach(order => {
                        const row = tableBody.insertRow();
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td>${order.customOrderId || order._id.substring(0, 8)}</td>
                            <td>${order.customerName}</td>
                            <td>${order.items.map(item => `${item.name} x ${item.quantity}`).join(', ')}</td>
                            <td>₹${order.totalAmount.toFixed(2)}</td>
                            <td><span class="status-badge ${getStatusBadgeClass(order.status)}">${order.status}</span></td>
                            <td>${formatTimestamp(order.orderDate)}</td>
                            <td>
                                <button class="btn btn-info btn-sm view-order-details" data-id="${order._id}" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                    });
                    addOrderDetailsEventListeners();
                } catch (error) {
                    console.error('Error fetching recent orders:', error);
                    showMessageModal('Error', 'Failed to load recent orders.');
                }
            }

            // --- Menu Management ---
            async function fetchMenuItems() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/menu', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch menu items.');
                    }
                    const items = await response.json();
                    const tableBody = document.getElementById('menu-table-body');
                    tableBody.innerHTML = '';

                    if (items.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">No menu items. Click "Add New Item" to add some.</td></tr>';
                        return;
                    }

                    items.forEach(item => {
                        const row = tableBody.insertRow();
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="w-20 h-20"><img src="${item.imageUrl || `https://placehold.co/80x80/cccccc/333333?text=${encodeURIComponent(item.name.substring(0, 10))}`}" alt="${item.name}" class="w-full h-full object-cover rounded-md"></td>
                            <td>${item.name}</td>
                            <td>${item.description || '-'}</td>
                            <td>₹${item.price.toFixed(2)}</td>
                            <td>${item.category || '-'}</td>
                            <td><i class="fas ${item.isAvailable ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} text-lg"></i></td>
                            <td><i class="fas ${item.isTrending ? 'fa-star text-yellow-500' : 'fa-minus-circle text-gray-400'} text-lg"></i></td>
                            <td class="whitespace-nowrap">
                                <button class="btn btn-primary btn-sm edit-menu-item-button mr-2" data-id="${item._id}" title="Edit Item">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-menu-item-button" data-id="${item._id}" title="Delete Item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                    });
                    addMenuItemEventListeners();
                } catch (error) {
                    console.error('Error fetching menu items:', error);
                    showMessageModal('Error', 'Failed to load menu items.');
                }
            }

            function addMenuItemEventListeners() {
                document.querySelectorAll('.edit-menu-item-button').forEach(button => {
                    button.addEventListener('click', (e) => openEditMenuItemModal(e.currentTarget.dataset.id));
                });
                document.querySelectorAll('.delete-menu-item-button').forEach(button => {
                    button.addEventListener('click', (e) => deleteMenuItem(e.currentTarget.dataset.id));
                });
            }

            document.getElementById('add-menu-item-button').addEventListener('click', () => {
                editModalTitle.textContent = 'Add New Menu Item';
                menuItemForm.reset();
                editItemId.value = ''; // Clear ID for new item
                editMenuItemModal.classList.remove('hidden');
            });

            async function openEditMenuItemModal(itemId) {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/admin/menu/${itemId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch menu item for editing.');
                    }
                    const item = await response.json();
                    editModalTitle.textContent = 'Edit Menu Item';
                    editItemId.value = item._id;
                    editItemName.value = item.name;
                    editItemDescription.value = item.description || '';
                    editItemPrice.value = item.price;
                    editItemImageUrl.value = item.imageUrl || '';
                    editItemCategory.value = item.category || '';
                    editItemIsAvailable.checked = item.isAvailable;
                    editItemIsTrending.checked = item.isTrending;
                    editMenuItemModal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error opening edit modal:', error);
                    showMessageModal('Error', 'Failed to load item details for editing.');
                }
            }

            menuItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const itemId = editItemId.value;
                const method = itemId ? 'PUT' : 'POST';
                const url = itemId ? `/api/admin/menu/${itemId}` : '/api/admin/menu';

                const itemData = {
                    name: editItemName.value,
                    description: editItemDescription.value,
                    price: parseFloat(editItemPrice.value),
                    imageUrl: editItemImageUrl.value,
                    category: editItemCategory.value,
                    isAvailable: editItemIsAvailable.checked,
                    isTrending: editItemIsTrending.checked
                };

                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(itemData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                        editMenuItemModal.classList.add('hidden');
                        fetchMenuItems();
                    } else {
                        showMessageModal('Error', data.message || 'Failed to save menu item.');
                    }
                } catch (error) {
                    console.error('Error saving menu item:', error);
                    showMessageModal('Error', 'Failed to save menu item.');
                }
            });

            async function deleteMenuItem(itemId) {
                if (!confirm('Are you sure you want to delete this menu item?')) {
                    return;
                }
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/admin/menu/${itemId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                        fetchMenuItems();
                    } else {
                        showMessageModal('Error', data.message || 'Failed to delete menu item.');
                    }
                } catch (error) {
                    console.error('Error deleting menu item:', error);
                    showMessageModal('Error', 'Failed to delete menu item.');
                }
            }

            // --- Order Management ---
            async function fetchOrders() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/orders', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch orders.');
                    }
                    let orders = await response.json();

                    const statusFilter = document.getElementById('order-status-filter').value;
                    const searchFilter = document.getElementById('order-search').value.toLowerCase();

                    if (statusFilter) {
                        orders = orders.filter(order => order.status === statusFilter);
                    }
                    if (searchFilter) {
                        orders = orders.filter(order =>
                            order.customOrderId?.toLowerCase().includes(searchFilter) ||
                            order.customerPhone.toLowerCase().includes(searchFilter) ||
                            order.customerName?.toLowerCase().includes(searchFilter)
                        );
                    }

                    const tableBody = document.getElementById('orders-table-body');
                    tableBody.innerHTML = '';

                    if (orders.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No orders found.</td></tr>';
                        return;
                    }

                    orders.forEach(order => {
                        const row = tableBody.insertRow();
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td>${order.customOrderId || order._id.substring(0, 8)}</td>
                            <td>${order.customerName || 'N/A'}</td>
                            <td>${order.customerPhone}</td>
                            <td>${order.items.map(item => `${item.name} x ${item.quantity}`).join(', ')}</td>
                            <td>₹${order.totalAmount.toFixed(2)}</td>
                            <td>
                                <select class="input-field order-status-select" data-id="${order._id}">
                                    <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                                    <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                                    <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                    <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </td>
                            <td>${order.paymentMethod}</td>
                            <td>${formatTimestamp(order.orderDate)}</td>
                            <td class="whitespace-nowrap">
                                <button class="btn btn-info btn-sm view-order-details mr-2" data-id="${order._id}" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-order-button" data-id="${order._id}" title="Delete Order">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                    });
                    addOrderDetailsEventListeners();
                    addOrderActionsEventListeners();
                } catch (error) {
                    console.error('Error fetching orders:', error);
                    showMessageModal('Error', 'Failed to load orders.');
                }
            }

            document.getElementById('apply-order-filter').addEventListener('click', fetchOrders);
            document.getElementById('order-search').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    fetchOrders();
                }
            });

            function addOrderDetailsEventListeners() {
                document.querySelectorAll('.view-order-details').forEach(button => {
                    button.addEventListener('click', (e) => viewOrderDetails(e.currentTarget.dataset.id));
                });
            }

            function addOrderActionsEventListeners() {
                document.querySelectorAll('.order-status-select').forEach(select => {
                    select.addEventListener('change', (e) => updateOrderStatus(e.currentTarget.dataset.id, e.currentTarget.value));
                });
                document.querySelectorAll('.delete-order-button').forEach(button => {
                    button.addEventListener('click', (e) => deleteOrder(e.currentTarget.dataset.id));
                });
            }

            async function viewOrderDetails(orderId) {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/admin/orders/${orderId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch order details.');
                    }
                    const order = await response.json();

                    document.getElementById('modal-order-id').textContent = order.customOrderId || order._id;
                    document.getElementById('modal-order-pin').textContent = order.pinId || 'N/A';
                    document.getElementById('modal-customer-name').textContent = order.customerName || 'N/A';
                    document.getElementById('modal-customer-phone').textContent = order.customerPhone;
                    document.getElementById('modal-delivery-address').textContent = order.deliveryAddress || 'N/A';
                    document.getElementById('modal-customer-location').textContent = order.customerLocation ? `Lat: ${order.customerLocation.latitude}, Lon: ${order.customerLocation.longitude} (${order.customerLocation.address || 'Unknown Address'})` : 'N/A';

                    const itemsList = document.getElementById('modal-order-items');
                    itemsList.innerHTML = '';
                    order.items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = `${item.name} x ${item.quantity} (₹${item.price.toFixed(2)} each)`;
                        itemsList.appendChild(li);
                    });

                    document.getElementById('modal-subtotal').textContent = order.subtotal ? order.subtotal.toFixed(2) : '0.00';
                    document.getElementById('modal-transport-tax').textContent = order.transportTax ? order.transportTax.toFixed(2) : '0.00';
                    document.getElementById('modal-discount-amount').textContent = order.discountAmount ? order.discountAmount.toFixed(2) : '0.00';
                    document.getElementById('modal-total-amount').textContent = order.totalAmount.toFixed(2);
                    document.getElementById('modal-payment-method').textContent = order.paymentMethod;
                    
                    const modalStatusSpan = document.getElementById('modal-status');
                    modalStatusSpan.textContent = order.status;
                    modalStatusSpan.className = `status-badge ${getStatusBadgeClass(order.status)}`;

                    document.getElementById('modal-order-date').textContent = formatTimestamp(order.orderDate);

                    orderDetailsModal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error viewing order details:', error);
                    showMessageModal('Error', 'Failed to load order details.');
                }
            }

            async function updateOrderStatus(orderId, newStatus) {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/admin/orders/${orderId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                        fetchOrders(); // Refresh the list
                        fetchDashboardStats(); // Update dashboard stats
                    } else {
                        showMessageModal('Error', data.message || 'Failed to update order status.');
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    showMessageModal('Error', 'Failed to update order status.');
                }
            }

            async function deleteOrder(orderId) {
                if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                    return;
                }
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/admin/orders/${orderId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                        fetchOrders();
                        fetchDashboardStats();
                    } else {
                        showMessageModal('Error', data.message || 'Failed to delete order.');
                    }
                } catch (error) {
                    console.error('Error deleting order:', error);
                    showMessageModal('Error', 'Failed to delete order.');
                }
            }

            // --- Customer Management ---
            async function fetchCustomers() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/customers', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch customers.');
                    }
                    let customers = await response.json();

                    const searchFilter = document.getElementById('customer-search').value.toLowerCase();
                    if (searchFilter) {
                        customers = customers.filter(customer =>
                            customer.customerPhone.toLowerCase().includes(searchFilter) ||
                            customer.customerName?.toLowerCase().includes(searchFilter)
                        );
                    }

                    const tableBody = document.getElementById('customers-table-body');
                    tableBody.innerHTML = '';

                    if (customers.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No customers found.</td></tr>';
                        return;
                    }

                    customers.forEach(customer => {
                        const row = tableBody.insertRow();
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td>${customer.customerPhone}</td>
                            <td>${customer.customerName || 'N/A'}</td>
                            <td>${customer.totalOrders}</td>
                            <td>${customer.lastOrderDate ? formatTimestamp(customer.lastOrderDate) : 'N/A'}</td>
                            <td>${customer.lastKnownLocation ? `${customer.lastKnownLocation.address || 'Unknown Address'}` : 'N/A'}</td>
                            <td>
                                <button class="btn btn-danger btn-sm delete-customer-button" data-id="${customer._id}" title="Delete Customer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                    });
                    addCustomerActionsEventListeners();
                } catch (error) {
                    console.error('Error fetching customers:', error);
                    showMessageModal('Error', 'Failed to load customers.');
                }
            }

            document.getElementById('apply-customer-filter').addEventListener('click', fetchCustomers);
            document.getElementById('customer-search').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    fetchCustomers();
                }
            });

            function addCustomerActionsEventListeners() {
                document.querySelectorAll('.delete-customer-button').forEach(button => {
                    button.addEventListener('click', (e) => deleteCustomer(e.currentTarget.dataset.id));
                });
            }

            async function deleteCustomer(customerId) {
                if (!confirm('Are you sure you want to delete this customer? This will not delete their past orders, but will remove their customer record.')) {
                    return;
                }
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch(`/api/admin/customers/${customerId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                        fetchCustomers();
                        fetchDashboardStats();
                    } else {
                        showMessageModal('Error', data.message || 'Failed to delete customer.');
                    }
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    showMessageModal('Error', 'Failed to delete customer.');
                }
            }

            // --- Settings Management ---
            async function fetchSettings() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/settings', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch settings.');
                    }
                    const settings = await response.json();

                    shopNameInput.value = settings.shopName || '';
                    shopLatitudeInput.value = settings.shopLocation?.latitude || '';
                    shopLongitudeInput.value = settings.shopLocation?.longitude || '';

                    renderDeliveryRates(settings.deliveryRates || []);
                } catch (error) {
                    console.error('Error fetching settings:', error);
                    showMessageModal('Error', 'Failed to load general settings.');
                }
            }

            generalSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const settingsData = {
                    shopName: shopNameInput.value,
                    shopLocation: {
                        latitude: parseFloat(shopLatitudeInput.value),
                        longitude: parseFloat(shopLongitudeInput.value)
                    }
                };

                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/settings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(settingsData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                    } else {
                        showMessageModal('Error', data.message || 'Failed to save general settings.');
                    }
                } catch (error) {
                    console.error('Error saving general settings:', error);
                    showMessageModal('Error', 'Failed to save general settings.');
                }
            });

            function renderDeliveryRates(rates) {
                deliveryRatesContainer.innerHTML = '';
                if (rates.length === 0) {
                    deliveryRatesContainer.innerHTML = '<p class="text-gray-500">No delivery rates configured. Click "Add Delivery Rate" to add some.</p>';
                }
                rates.forEach((rate, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3';
                    div.innerHTML = `
                        <div class="flex-grow w-full sm:w-auto">
                            <label class="form-label">KMs</label>
                            <input type="number" step="0.01" placeholder="KMs" value="${rate.kms}" class="input-field delivery-kms" data-index="${index}" required>
                        </div>
                        <div class="flex-grow w-full sm:w-auto">
                            <label class="form-label">Amount (₹)</label>
                            <input type="number" step="0.01" placeholder="Amount (₹)" value="${rate.amount}" class="input-field delivery-amount" data-index="${index}" required>
                        </div>
                        <button type="button" class="btn btn-danger btn-sm remove-delivery-rate sm:mt-6" data-index="${index}" title="Remove Rate">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    deliveryRatesContainer.appendChild(div);
                });
                addRemoveDeliveryRateListeners();
            }

            function addRemoveDeliveryRateListeners() {
                document.querySelectorAll('.remove-delivery-rate').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.target.closest('div').remove();
                    });
                });
            }

            addDeliveryRateButton.addEventListener('click', () => {
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-3';
                div.innerHTML = `
                    <div class="flex-grow w-full sm:w-auto">
                        <label class="form-label">KMs</label>
                        <input type="number" step="0.01" placeholder="KMs" class="input-field delivery-kms" required>
                    </div>
                    <div class="flex-grow w-full sm:w-auto">
                        <label class="form-label">Amount (₹)</label>
                        <input type="number" step="0.01" placeholder="Amount (₹)" class="input-field delivery-amount" required>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm remove-delivery-rate sm:mt-6" title="Remove Rate">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                deliveryRatesContainer.appendChild(div);
                addRemoveDeliveryRateListeners(); // Re-add listeners for new buttons
            });

            saveDeliveryRatesButton.addEventListener('click', async () => {
                const rates = [];
                let isValid = true;
                document.querySelectorAll('#delivery-rates-container > div').forEach(div => {
                    const kmsInput = div.querySelector('.delivery-kms');
                    const amountInput = div.querySelector('.delivery-amount');
                    const kms = parseFloat(kmsInput.value);
                    const amount = parseFloat(amountInput.value);

                    if (isNaN(kms) || isNaN(amount) || kms < 0 || amount < 0) {
                        isValid = false;
                        showMessageModal('Validation Error', 'Please enter valid non-negative numbers for KMs and Amount.');
                        return;
                    }
                    rates.push({ kms, amount });
                });

                if (!isValid) return;

                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/settings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ deliveryRates: rates })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                        fetchSettings(); // Re-fetch to confirm
                    } else {
                        showMessageModal('Error', data.message || 'Failed to save delivery rates.');
                    }
                } catch (error) {
                    console.error('Error saving delivery rates:', error);
                    showMessageModal('Error', 'Failed to save delivery rates.');
                }
            });

            async function fetchDiscountSettings() {
                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/discount-settings', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        throw new Error('Failed to fetch discount settings.');
                    }
                    const settings = await response.json();
                    minSubtotalDiscountInput.value = settings.minSubtotalForDiscount;
                    discountPercentageInput.value = settings.discountPercentage;
                } catch (error) {
                    console.error('Error fetching discount settings:', error);
                    showMessageModal('Error', 'Failed to load discount settings.');
                }
            }

            discountSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const discountData = {
                    minSubtotalForDiscount: parseFloat(minSubtotalDiscountInput.value),
                    discountPercentage: parseFloat(discountPercentageInput.value)
                };

                try {
                    const token = localStorage.getItem('jwtToken');
                    const response = await fetch('/api/admin/discount-settings', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(discountData)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessageModal('Success', data.message);
                    } else {
                        showMessageModal('Error', data.message || 'Failed to save discount settings.');
                    }
                } catch (error) {
                    console.error('Error saving discount settings:', error);
                    showMessageModal('Error', 'Failed to save discount settings.');
                }
            });


            // --- Initial Load ---
            checkAuth().then(isAuthenticated => {
                if (isAuthenticated) {
                    // If authenticated, ensure the correct section is shown based on hash or default
                    if (window.location.hash) {
                        const initialSection = window.location.hash.substring(1);
                        showSection(initialSection + '-section');
                    } else {
                        showSection('dashboard-section');
                    }
                }
            });
        });
    </script>
</body>
</html>
