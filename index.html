<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Leaflet GPS Map (Live + Pin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #f5f8fb; font-family: 'Segoe UI',sans-serif; }
    #map { height: 100vh; width: 100vw; }
    .floating-ui {
      position: absolute; z-index: 1000; top: 16px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 10px; background: rgba(255,255,255,0.95); border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15); padding: 12px 18px;
    }
    .floating-ui button {
      background: #2266ff; color: #fff; border: none; border-radius: 20px; padding: 8px 18px; font-size: 1rem;
      cursor: pointer; transition: background 0.2s;
      box-shadow: 0 2px 6px rgba(44,98,180,0.10);
    }
    .floating-ui button.active, .floating-ui button:hover { background: #1144aa; }
    .address-display {
      position: absolute; bottom: 28px; left: 50%; transform: translateX(-50%);
      padding: 12px 20px; border-radius: 14px; min-width: 240px;
      background: rgba(255,255,255,0.98); box-shadow: 0 2px 10px rgba(0,0,0,0.10);
      font-size: 1rem; color: #222; z-index: 1000;
      text-align: center; max-width: calc(100vw - 36px);
      word-break: break-word; font-weight: 500;
    }
    @media (max-width: 600px) {
      .floating-ui { flex-direction: column; top: 8px; left: 50%; transform: translateX(-50%); }
      .address-display { font-size: 0.95rem; padding: 8px 8px; }
    }
  </style>
</head>
<body>
  <!-- Map Controls -->
  <div class="floating-ui">
    <button id="liveBtn" class="active">Live Location</button>
    <button id="pinBtn">Pin Location</button>
  </div>
  <!-- Address Output -->
  <div id="address" class="address-display">Loading locationâ€¦</div>
  <!-- Map -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // State variables
    let map, liveMarker, pinMarker, currentMode, watchId;
    const addressDisplay = document.getElementById('address');
    const liveBtn = document.getElementById('liveBtn');
    const pinBtn = document.getElementById('pinBtn');
    // Nominatim reverse geocode helper
    async function reverseGeocode(lat, lon) {
      // Add your contact email if possible to meet usage terms
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=jsonv2&email=test@example.com`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Network');
        const data = await res.json();
        return data.display_name || 'No address found';
      } catch (e) {
        return 'Reverse geocoding failed';
      }
    }
    // Display helper for coordinates/address
    function updateAddress(lat, lon, address) {
      addressDisplay.innerHTML = `<div><b>Lat:</b> ${lat.toFixed(6)}<br><b>Lng:</b> ${lon.toFixed(6)}</div>
      <div style="margin-top:7px;color:#555;"><span style="font-size:0.97em;">ðŸ”Ž </span>${address}</div>`;
    }
    // Center and update marker/address for live location
    function centerToLiveLocation(e) {
      const lat = e.coords.latitude, lon = e.coords.longitude;
      if (!map) return;
      map.setView([lat, lon], 16, { animate: true });
      if (liveMarker) liveMarker.setLatLng([lat, lon]);
      else liveMarker = L.marker([lat, lon], {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/447/447031.png',iconSize:[32,32],iconAnchor:[16,28]})}).addTo(map);
      // Remove pin marker if in live
      if (pinMarker) { map.removeLayer(pinMarker); pinMarker = null; }
      reverseGeocode(lat, lon).then(addr => updateAddress(lat, lon, addr));
    }
    // Error handler (no GPS, permission denied)
    function onGeoError(e) {
      addressDisplay.textContent = `Unable to get GPS: ${e.message || e}`;
    }
    // Switch to live GPS tracking mode
    function activateLiveMode() {
      liveBtn.classList.add('active'); pinBtn.classList.remove('active');
      currentMode = 'live';
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = navigator.geolocation.watchPosition(centerToLiveLocation, onGeoError, {enableHighAccuracy:true,timeout:6000});
      map.off('click'); // Disable pin handler
    }
    // Switch to pin (pick on map) mode
    function activatePinMode() {
      pinBtn.classList.add('active'); liveBtn.classList.remove('active');
      currentMode = 'pin';
      if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
      map.once('click', async function(e){
        const lat = e.latlng.lat, lon = e.latlng.lng;
        // Remove previous pin
        if (pinMarker) pinMarker.setLatLng([lat, lon]);
        else pinMarker = L.marker([lat, lon], {icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/854/854878.png',iconSize:[32,32],iconAnchor:[16,28]})}).addTo(map);
        // Remove live marker
        if (liveMarker) { map.removeLayer(liveMarker); liveMarker = null; }
        map.setView([lat, lon], 16, { animate: true });
        let addr = await reverseGeocode(lat, lon);
        updateAddress(lat, lon, addr);
      });
      addressDisplay.textContent = "Tap on map to pin a location.";
    }
    // Button event bindings
    liveBtn.onclick = activateLiveMode;
    pinBtn.onclick = activatePinMode;

    // Initialize map and live location on load
    window.onload = function() {
      map = L.map('map').setView([18.5214, 73.8544], 13); // Start at Pune, India if no GPS
      // Integrate OSM tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      // Default to 'live' on load
      activateLiveMode();
    };
  </script>
</body>
</html>
