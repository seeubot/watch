<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicious Bites - Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzxH+GnBFwDChDLEFNyJsTddoCA="
     crossorigin=""/>
    <!-- Leaflet Control Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        /* ... (all your style rules remain unchanged) ... */
    </style>
</head>
<body class="min-h-screen">
    <!-- ... (all header, modals, main content etc. unchanged) ... -->

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjGwZZ1Xz0GbnSe75Lp9js+9dxFVQ="
     crossorigin=""></script>
    <!-- Leaflet Control Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // ... (all global variables and DOM references unchanged) ...

        // --- GPS + Live Location UPDATED CODE ---

        function getCurrentLocationForMap() {
            if (!navigator.geolocation) {
                showNotification('Geolocation is not supported by your browser!', 'error');
                return;
            }

            // Show loading
            mapLocationStatus.textContent = "Fetching your live location...";

            // Stop previous watcher if running
            if (geolocationWatcherId) navigator.geolocation.clearWatch(geolocationWatcherId);

            geolocationWatcherId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, accuracy } = pos.coords;
                    lastKnownLiveCoords = { latitude, longitude };

                    if (map) {
                        map.setView([latitude, longitude], 17, { animate: true });

                        // Create/update animated live marker
                        if (liveMarker) {
                            liveMarker.setLatLng([latitude, longitude]);
                        } else {
                            liveMarker = L.marker([latitude, longitude], { icon: liveSVGIcon() })
                                .addTo(map)
                                .bindPopup('Your live GPS position');
                        }

                        // Update accuracy circle
                        if (userCircle) {
                            userCircle.setLatLng([latitude, longitude]);
                            userCircle.setRadius(accuracy);
                        } else {
                            userCircle = L.circle([latitude, longitude], { 
                                color: '#1976d2', fillColor: '#1976d2', fillOpacity: 0.1, radius: accuracy 
                            }).addTo(map);
                        }
                    }
                    mapLocationStatus.textContent = "Live location found. You can move or save this.";
                },
                (err) => {
                    let msg = "Failed to get your location - ";
                    if (err.code === 1) msg += "Permission denied.";
                    else if (err.code === 2) msg += "Position unavailable.";
                    else if (err.code === 3) msg += "Timeout.";
                    else msg += err.message;
                    showNotification(msg, 'error');
                    mapLocationStatus.textContent = msg;
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function cleanupMapAndGeolocation() {
            if (geolocationWatcherId) {
                navigator.geolocation.clearWatch(geolocationWatcherId);
                geolocationWatcherId = null;
            }
            if (map) {
                if (liveMarker) { map.removeLayer(liveMarker); liveMarker = null; }
                if (userCircle) { map.removeLayer(userCircle); userCircle = null; }
                // Optionally also remove delivery marker
            }
            lastKnownLiveCoords = null;
            mapInitialized = false;
        }

        // --- END OF UPDATED CODE ---

        // ... (rest of your JS code for menu, cart, modal handling, UI, map initialization, etc., remains the same) ...
    </script>
</body>
</html>
