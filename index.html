<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Menu Panel (B&W â€¢ Mobile)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style>
        :root {
            --bg: #111;
            --fg: #fff;
            --accent: #e2e2e2;
            --emph: #000;
            --btn: #222;
            --btn-hover: #444;
        }
        html, body {
            margin: 0; padding: 0; background: var(--bg); color: var(--fg);
            font-family: 'Segoe UI', Arial, sans-serif; font-size: 17px; height: 100%;
        }
        #panel-menu {
            max-width: 535px; width: 100%; margin: 0 auto; min-height: 100vh; background: var(--bg);
            padding: 0 0 .7em 0;
        }
        h2 { color: var(--fg); margin: 1em 0 .7em 0; font-size: 1.4em;}
        .menu-header {
            display: flex; justify-content: space-between; align-items: center; margin: 1.1em .5em .7em .5em;
            flex-wrap: wrap; gap: 7px;
        }
        input, select, button, textarea {
            width: 100%; background: var(--fg); color: var(--bg); border: none; border-radius: 5px;
            margin: .6em 0; padding: .91em .7em; font-size: 1em; outline: none;
        }
        input[type="checkbox"] { width:auto; display:inline-block; margin-right:.4em;}
        textarea { resize: vertical; min-height: 40px;}
        button {
            background: var(--btn); color: var(--fg); border: none; border-radius: 5px; font-weight: bold;
            margin: .5em 0; transition: .15s;
        }
        button:active, button:focus, button:hover { background: var(--btn-hover);}
        .bbtn { width: 48%; margin-right: 3%;}
        .search-box { width: 60%; }
        .add-btn { width: 36%; background: var(--emph); color: var(--fg);}
        table {
            width: 100%; font-size: .95em; border-collapse: collapse; margin-bottom: 1em; color: var(--fg);
        }
        th, td { border: 1px solid #444; padding: .75em .4em; }
        th { background: var(--btn); color: var(--accent);}
        tr:nth-child(even) { background: #191919; }
        .act-btns button { width: 2.4em; margin-right: .1em; }
        .panel, .modal-bg { background: var(--bg);}
        .modal-bg {
            position: fixed; z-index: 9999; top:0; left:0; width:100vw; height:100vh; background: rgba(0,0,0,.88);
            display: none; justify-content: center; align-items: center;
        }
        .modal-card {
            background: #fff; color: #111; border-radius: 9px; min-width: 280px; max-width: 95vw;
            padding: 1.3em 1em 1em 1em;
            box-shadow: 0 2px 8px #111;
        }
        .modal-card input, .modal-card select, .modal-card textarea {
            background: #f5f5f5; color: #111; border: 1.4px solid #eee; margin: .5em 0;
        }
        .modal-card label {color: #111;}
        .imgPreview { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; margin:.2em 0;}
        @media (max-width:610px){
            #panel-menu { padding: 0 .32em 1.2em .32em;}
            html { font-size: 15px;}
            .menu-header { flex-direction:column;}
        }
    </style>
</head>
<body>
<section id="panel-menu">
    <h2>Menu Panel</h2>
    <div class="menu-header">
        <input class="search-box" id="menuSearch" placeholder="Search menu..." oninput="renderMenuTable()" />
        <button class="add-btn" onclick="openMenuForm()">+ Add Item</button>
    </div>
    <div id="menuMsg" style="color:#fff;font-size:.99em;text-align:center;"></div>
    <div id="menuTableArea"></div>
</section>

<div class="modal-bg" id="menuModal">
    <div class="modal-card" id="menuModalCard">
        <!-- Menu item form inserted here -->
    </div>
</div>

<script>
let menuData = [], menuLastSearch = "";
async function api(path, options={}) {
    let res = await fetch(path, options);
    if(res.ok) return await res.json();
    else throw (await res.json()).message || "API error";
}
// ---- Main Loader ----
async function loadMenuPanel() {
    document.getElementById('menuMsg').textContent = "Loading...";
    try {
        menuData = await api('/api/admin/menu');
        document.getElementById('menuMsg').textContent = "";
        renderMenuTable();
    } catch(e){
        document.getElementById('menuMsg').textContent = "Failed to load menu.";
    }
}
function renderMenuTable() {
    let q = document.getElementById('menuSearch').value?.toLowerCase() || '';
    let rows = menuData.filter(m => (m.name&&m.name.toLowerCase().includes(q)) || (m.category&&(m.category.toLowerCase().includes(q))))
        .map(m=>`
        <tr>
            <td>${m.imageUrl?`<img src="${m.imageUrl}" class="imgPreview" />`:''}</td>
            <td>
                <b>${m.name}</b><br>
                <small>${m.description||''}</small>
            </td>
            <td>â‚¹${m.price}</td>
            <td>${m.category||''}</td>
            <td><input type="checkbox" onchange="toggleAvailable('${m._id}',this)" ${m.isAvailable?'checked':''}></td>
            <td><input type="checkbox" onchange="toggleTrending('${m._id}',this)" ${m.isTrending?'checked':''}></td>
            <td class="act-btns">
                <button onclick="openMenuForm('${m._id}')">âœŽ</button>
                <button onclick="removeMenuItem('${m._id}')">ðŸ—‘</button>
            </td>
        </tr>
        `).join('');
    document.getElementById('menuTableArea').innerHTML = `
        <table>
        <tr>
            <th>Img</th><th>Name<br>Desc</th><th>Price</th><th>Cat</th>
            <th>Avail</th><th>Trend</th><th>Act</th>
        </tr>
        ${rows || '<tr><td colspan="7" style="text-align:center;">No menu found</td></tr>'}
        </table>
    `;
}
function openMenuForm(id) {
    let m = id ? menuData.find(x=>x._id===id) : {
        name:'',price:'',description:'',imageUrl:'',category:'',isAvailable:true,isTrending:false
    };
    document.getElementById('menuModal').style.display = 'flex';
    document.getElementById('menuModalCard').innerHTML = `
    <form id="menuItemForm" onsubmit="return submitMenuItem('${id||''}')">
        <label>Name<input id="mname" value="${m.name||''}" required></label>
        <label>Price<input id="mprice" type="number" step="0.01" value="${m.price||''}" required></label>
        <label>Category<input id="mcat" value="${m.category||''}"></label>
        <label>Description<textarea id="mdesc">${m.description||''}</textarea></label>
        <label>Image URL<input id="murl" value="${m.imageUrl||''}" onchange="previewMenuImg()" placeholder="http://..." /></label>
        <div id="imgPrevWrap">${m.imageUrl?`<img src="${m.imageUrl}" class="imgPreview" />`:''}</div>
        <label><input type="checkbox" id="mavail" ${m.isAvailable?'checked':''}/> Available</label>
        <label><input type="checkbox" id="mtrend" ${m.isTrending?'checked':''}/> Trending</label>
        <div style="display:flex;gap:8px;">
            <button class="bbtn" style="background:#222;">Save</button>
            <button type="button" class="bbtn" style="background:#999;color:#000;" onclick="closeMenuForm()">Cancel</button>
        </div>
    </form>
    `;
}
function closeMenuForm(){ document.getElementById('menuModal').style.display = 'none'; }
function previewMenuImg() {
    let url = document.getElementById('murl').value;
    document.getElementById('imgPrevWrap').innerHTML = url ? `<img src="${url}" class="imgPreview" />` : '';
}
async function submitMenuItem(id) {
    let data = {
        name: document.getElementById('mname').value,
        price: parseFloat(document.getElementById('mprice').value),
        category: document.getElementById('mcat').value,
        description: document.getElementById('mdesc').value,
        imageUrl: document.getElementById('murl').value,
        isAvailable: document.getElementById('mavail').checked,
        isTrending: document.getElementById('mtrend').checked,
    };
    try {
        if(!data.name || !data.price) throw "Name + price needed";
        if(id) await api(`/api/admin/menu/${id}`, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        else await api('/api/admin/menu', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        closeMenuForm();
        loadMenuPanel();
    } catch(e){ alert("Error: " + e);}
    return false;
}
async function removeMenuItem(id){
    if(confirm('Delete this item?')){
        await api(`/api/admin/menu/${id}`, {method:'DELETE'});
        loadMenuPanel();
    }
}
async function toggleAvailable(id,el){
    await api(`/api/admin/menu/${id}`, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({isAvailable:el.checked})});
    loadMenuPanel();
}
async function toggleTrending(id,el){
    await api(`/api/admin/menu/${id}`, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({isTrending:el.checked})});
    loadMenuPanel();
}
window.onclick = function(ev){ if(ev.target==document.getElementById('menuModal')) closeMenuForm(); };

window.onload = loadMenuPanel;
</script>
</body>
</html>
