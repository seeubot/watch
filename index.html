<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Leaflet Map – Live, Search, Black & White w/Labels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; background:#111; color:#fff;}
    #map { width:100vw; height:100vh; position:absolute; top:0; left:0; }
    .searchbox {
      position:fixed; top:24px; left:50%; transform:translateX(-50%); z-index:1101;
      background:#fff; color:#232323; border:2px solid #232323; border-radius:16px;
      padding:.7em 1em; font-size:1em; min-width:250px; outline:none; font-weight:500;
      box-shadow:0 2px 12px #0003;
    }
    .suggestions {
      position: absolute; left:50%; transform:translateX(-50%); top:64px;
      background:#fafafa; color:#232323; border-radius:13px; box-shadow:0 2px 16px #0004;
      min-width:250px; z-index:1200; font-size:1em; max-height:220px; overflow-y:auto; display:none;
      border:1.5px solid #e1e1e1;
    }
    .suggestions.show { display:block; }
    .suggestions div { padding:.55em 1em; cursor:pointer; border-bottom:1px solid #ececec;}
    .suggestions div:last-child { border-bottom:none; }
    .suggestions div:hover { background:#efefef; color:#111;}
    .fab {
      position:fixed; bottom:24px; left:26px; width:56px; height:56px;
      border-radius:50%; border:none; color:#fff; background:#232323; z-index:1102;
      display:flex; align-items:center; justify-content:center; font-size:2em;
      box-shadow:0 2px 7px #0002; cursor:pointer; transition: background .18s;
    }
    .fab:active, .fab.flash { background:#888; }
    .toast {
      position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
      background: #232323; color: #fff; font-size: 1em;
      border-radius:9px; padding:1em 2em; opacity:0; z-index:1302;
      transition:opacity 0.3s; pointer-events: none;
      box-shadow: 0px 2px 8px #0003;
    }
    .toast.show { opacity:1; pointer-events:auto; }
    /* Live marker pulse highlight */
    .live-pulse { box-shadow:0 0 0 6px #fff8 !important; transition:box-shadow 0.2s; }
    /* B&W map controls */
    .leaflet-control, .leaflet-pane { filter: grayscale(1) contrast(1.08) brightness(.99); }
    @media (max-width:600px){
      .fab { width:44px; height:44px; font-size:1.4em; }
      .searchbox,.suggestions { min-width:140px;}
    }
  </style>
</head>
<body>
  <input id="search" class="searchbox" type="text" autocomplete="off" placeholder="Search for a place..."/>
  <div id="suggestions" class="suggestions"></div>
  <div id="map"></div>
  <button id="center-btn" class="fab" title="Go to live location" aria-label="Go to live location">
    <svg viewBox="0 0 38 38" width="28" height="28" xmlns="http://www.w3.org/2000/svg">
      <circle cx="19" cy="19" r="19" fill="#fff"/>
      <polygon points="19,7 23,30 19,25 15,30"
        fill="#232323" stroke="#151515" stroke-width="1.7"/>
    </svg>
  </button>
  <div id="toast" class="toast"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Toast notifications
    function showToast(msg, duration=2300){
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), duration);
    }

    // Black & White base tiles WITH labels (Stamen Toner)
    const bwtile = L.tileLayer(
      "https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",
      { attribution:'Map tiles by Stamen Design, CC BY 3.0 — Map data © OpenStreetMap contributors', maxZoom:20 }
    );
    const map = L.map("map", {
      zoomControl:true, attributionControl:true, layers:[bwtile]
    }).setView([20.59,78.96], 5);

    // Custom SVG icons
    function svgIcon(svg, size, className) {
      return L.divIcon({ html:svg, iconSize:size, iconAnchor:[size[0]/2,size[1]], className });
    }
    const liveIcon = svgIcon(
      `<svg viewBox="0 0 38 38" width="38" height="38">
        <circle cx="19" cy="19" r="19" fill="#fff"/>
        <polygon points="19,7 23,30 19,25 15,30"
          fill="#232323" stroke="#151515" stroke-width="1.7"/>
      </svg>`, [38,38], "live-marker"
    );
    const pinIcon = L.icon({
      iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",
      iconSize:[38,38], iconAnchor:[19,38]
    });

    let liveMarker=null, userCircle=null, lastCoords=null, pinMarker=null;

    // Pin custom location on tap/click
    map.on('click', function(e) {
      if (pinMarker) map.removeLayer(pinMarker);
      pinMarker = L.marker(e.latlng, {icon:pinIcon})
                   .addTo(map)
                   .bindPopup("Delivery location").openPopup();
      showToast("Delivery location pinned!");
    });

    // Reliable, live GPS tracking
    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition(
        pos=>{
          const {latitude:lat, longitude:lng, accuracy} = pos.coords;
          if (liveMarker) map.removeLayer(liveMarker);
          if (userCircle) map.removeLayer(userCircle);
          liveMarker = L.marker([lat,lng], {icon:liveIcon})
                          .addTo(map)
                          .bindPopup(`You're here!<br>Accuracy: ±${Math.round(accuracy)}m`);
          userCircle = L.circle([lat,lng], {
            radius:accuracy, color:'#232323', fillColor:'#fff', fillOpacity:0.09, opacity:0.28
          }).addTo(map);
          if (!lastCoords) {
            map.setView([lat,lng], 17, {animate:true});
            showToast("Live location found!");
          }
          lastCoords = { lat, lng };
        },
        err=>showToast("Location error: "+err.message, 3200),
        { enableHighAccuracy:true, maximumAge:0, timeout:14000 }
      );
    } else {
      showToast("Geolocation not supported.", 3000);
    }

    // "Go to live" button with flash effect
    document.getElementById('center-btn').onclick = () => {
      if (lastCoords) {
        map.setView([lastCoords.lat, lastCoords.lng], map.getZoom(), { animate:true });
        if (liveMarker) {
          liveMarker._icon.classList.add("live-pulse");
          setTimeout(()=>liveMarker._icon.classList.remove("live-pulse"), 1000);
          liveMarker.openPopup();
        }
        showToast("Jumped to live location!", 1200);
      }
    };

    // --- Search with OpenStreetMap Nominatim ---
    const searchBox = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');
    let searchTimeout;
    searchBox.oninput = function() {
      clearTimeout(searchTimeout);
      const q = searchBox.value.trim();
      if (!q) { suggestions.classList.remove("show"); return; }
      searchTimeout = setTimeout(async ()=>{
        try{
          const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`);
          const data = await resp.json();
          suggestions.innerHTML = "";
          if(data.length){
            data.forEach(item => {
              const div = document.createElement("div");
              div.textContent = item.display_name;
              div.onclick = ()=>{
                const lat=+item.lat, lon=+item.lon;
                map.setView([lat,lon], 17, { animate:true });
                if(pinMarker) map.removeLayer(pinMarker);
                pinMarker = L.marker([lat,lon], {icon:pinIcon})
                  .addTo(map)
                  .bindPopup("Delivery location: "+item.display_name).openPopup();
                suggestions.classList.remove("show"); searchBox.value="";
                showToast("Location pinned & centered!",1400);
              };
              suggestions.appendChild(div);
            });
            suggestions.classList.add("show");
          } else {
            suggestions.innerHTML = "<div>No results found.</div>";
            suggestions.classList.add("show");
          }
        }catch{
          suggestions.innerHTML = "<div>Error searching location.</div>";
          suggestions.classList.add("show");
        }
      }, 600);
    };
    document.body.addEventListener("click", e=>{
      if(!searchBox.contains(e.target) && !suggestions.contains(e.target))
        suggestions.classList.remove("show");
    });
  </script>
</body>
</html>
