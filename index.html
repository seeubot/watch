<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - WhatsApp Orders (B&W Mobile UI)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style>
        :root {
            --primary: #111;
            --secondary: #fff;
            --accent: #e2e2e2;
            --sharp: #000;
            --button-bg: #181818;
            --button-hover: #444;
        }
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background: var(--primary); color: var(--secondary); font-family: 'Segoe UI', Arial, sans-serif; font-size: 16px;
        }
        #app {
            width: 100vw; min-height: 100vh;
            display: flex; flex-direction: column; justify-content: flex-start;
        }
        /* Mobile-focused container/panel */
        .container, .login-panel, .dashboard {
            width: 100%; max-width: 520px; margin: 0 auto; background: var(--primary); min-height: 100vh;
            border-radius:0; box-shadow: none; border: none; padding: 0 0 3.5em 0;
        }
        h2 { margin:1em 0 .5em 0; color:var(--secondary); font-size:1.5em;}
        input, select, button, textarea {
            display: block; width: 100%; background: var(--secondary); color: var(--primary);
            border: none; border-radius: 5px; margin: .48em 0; padding: .9em; font-size: 1em; outline: none;
        }
        textarea { resize: vertical; }
        input[type='checkbox'] { width: auto; display: inline-block; vertical-align: middle; margin-top:0; }
        button {
            background: var(--button-bg); color: var(--secondary); border: none; border-radius:5px;
            font-weight: bold; margin:.48em 0; transition: .15s;
        }
        button:active, button:focus, button:hover { background: var(--button-hover); color: var(--secondary); }
        label { color: var(--accent); font-size:.98em;}
        .tabs {
            display: flex; flex-wrap: nowrap; background:var(--primary); border-bottom: 1.5px solid var(--sharp);
            overflow-x: auto; position: sticky; top:0; z-index:10; margin-bottom:1em;
        }
        .tab {
            padding: .9em 0; background: none; border: none; color: var(--accent); font-size: 1.05em;
            flex:1; cursor: pointer; border-bottom: 2.5px solid transparent;
        }
        .tab.active { color: var(--secondary); border-bottom: 2.5px solid var(--secondary);}
        .panel { display: none; background:var(--primary);}
        .panel.active { display: block;}
        .stat-cards { display: flex; gap: 7px; justify-content: space-between; margin:.8em 0 1.2em 0;}
        .stat { flex:1 1 30%; background:var(--sharp); color:var(--secondary); padding:.7em; border-radius:6px; text-align:center;}
        #map { height: 200px; min-height: 140px; width: 100%; border-radius:8px; margin:1em 0;}
        table {
            width: 100%; border-collapse: collapse; font-size: .97em; margin-bottom: 1em;
            background: transparent; color: var(--secondary);
        }
        th, td { border: 1px solid #555; padding:.71em .4em; text-align:left;}
        th { background: var(--primary); color:var(--accent);}
        tr:nth-child(even) { background: #171717;}
        .status-dot { display: inline-block; width: 11px; height: 11px; vertical-align: middle; border-radius:50%;}
        .status-ready { background: #0f0; }
        .status-error { background: #db0c0c; }
        .status-wait { background: #aaa; }
        pre { background: #191919; color: #aad; border-radius: 7px; padding: 1em; font-size:.95em; }
        .sticky-top { position:sticky; top:0; z-index:99; background:var(--primary); }
        /* Hide scrollbars, keep scrolling smooth on mobile */
        ::-webkit-scrollbar {display: none;}
        /* Mobile responsive */
        @media(max-width:600px){
            html { font-size:15px;}
            h2 { font-size:1.18em;}
            .stat-cards { flex-direction: column; gap:9px;}
            .tabs { font-size:.99em;}
            table { font-size: .93em;}
            .container, .login-panel, .dashboard { max-width:100vw;padding:0 0 .7em 0;}
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
<div id="app">
    <!-- LOGIN -->
    <div class="login-panel" id="loginPanel" style="padding:3em 1em 1em 1em;">
        <h2>Admin Login</h2>
        <input id="loginUser" placeholder="Username" autocomplete="username" />
        <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password"/>
        <button onclick="login()">Login</button>
        <div id="loginMsg" style="color: #e74c3c; margin-top:.6em;"></div>
    </div>

    <!-- DASHBOARD -->
    <div class="container dashboard" id="dashboardPanel" style="display:none;padding:1em .6em;">
        <div class="sticky-top">
            <h2 style="margin-bottom:0;">Admin Dashboard
                <button onclick="logout()" style="float:right;width:auto;font-size:.97em;padding:.45em 1em;background:#000;">Logout</button>
            </h2>
            <div class="stat-cards">
                <div class="stat">
                    <b id="statOrders">0</b><br>Orders
                </div>
                <div class="stat">
                    <b id="statCustomers">0</b><br>Customers
                </div>
                <div class="stat">
                    <span id="botStatusDot" class="status-dot status-wait"></span>
                    <span id="botStatusText" style="font-size:.99em;">...</span>
                    <br>Bot
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="showTab('orders')">Orders</button>
                <button class="tab" onclick="showTab('menu')">Menu</button>
                <button class="tab" onclick="showTab('customers')">Customers</button>
                <button class="tab" onclick="showTab('settings')">Settings</button>
                <button class="tab" onclick="showTab('bot')">Bot</button>
            </div>
        </div>
        <div class="panel active" id="panel-orders"></div>
        <div class="panel" id="panel-menu"></div>
        <div class="panel" id="panel-customers"></div>
        <div class="panel" id="panel-settings"></div>
        <div class="panel" id="panel-bot"></div>
    </div>
</div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --------- Authentication ---------
async function login() {
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    document.getElementById('loginMsg').textContent = 'Logging in...';
    const res = await fetch('/admin/login', {
        method: 'POST', headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({username, password})
    });
    if (res.ok) {
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('dashboardPanel').style.display = '';
        loadAllPanels();
    } else {
        let data = await res.json(); document.getElementById('loginMsg').textContent = data.message || 'Login failed';
    }
}
async function logout() {
    await fetch('/admin/logout');
    location.reload();
}
function showTab(tab) {
    document.querySelectorAll('.tab').forEach((el,i)=>{
        el.classList.toggle('active', el.textContent.toLowerCase().includes(tab));
        document.querySelectorAll('.panel')[i].classList.toggle('active', el.textContent.toLowerCase().includes(tab));
    });
    if(tab==='customers' && window.lastDrawnMapLoc) setTimeout(()=>resetCustomerMap(window.lastDrawnMapLoc),350);
}
async function api(path, options={}){
    let r = await fetch(path, options);
    if(r.ok) return await r.json();
    else throw await r.json();
}
async function loadAllPanels() { loadOrders(); loadMenu(); loadCustomers(); loadSettings(); loadBotStatus(); socketInit(); }

// --------- Orders Panel ---------
async function loadOrders() {
    let panel = document.getElementById('panel-orders');
    panel.innerHTML = "<b>Loading orders...</b>";
    try {
        let orders = await api('/api/admin/orders');
        document.getElementById('statOrders').textContent = orders.length;
        panel.innerHTML = `
        <table>
            <tr><th>ID</th><th>Cust</th><th>Amt</th><th>St</th><th>Date</th><th>Act</th></tr>
            ${orders.map(o=>`
            <tr>
                <td>${o._id.slice(0,6)}</td>
                <td>${o.customerName||''}</td>
                <td>${o.totalAmount||''}</td>
                <td>${o.status||''}</td>
                <td>${(new Date(o.orderDate)).toLocaleString().substring(0,16)}</td>
                <td>
                    <button style="font-size:.98em;" onclick="orderDetails('${o._id}')">⮞</button>
                    <button style="font-size:.98em;" onclick="deleteOrder('${o._id}')">🗑</button>
                </td>
            </tr>
            `).join('')}
        </table>
        <div id="orderDetailArea"></div>
        `;
    } catch(e){ panel.innerHTML="<span style='color:#fa0'>Can't load orders!</span>"; }
}
async function orderDetails(id) {
    let d = await api(`/api/admin/orders/${id}`);
    let trk = `/track?orderId=${d._id}`;
    let panel = document.getElementById('orderDetailArea');
    panel.innerHTML = `
    <pre>
<b>Order ${d._id.slice(0,8)}</b>
Customer: ${d.customerName} | Phone: ${d.customerPhone}
Status: ${d.status}    Total: ₹${d.totalAmount}
${d.deliveryAddress ? 'Delivery: ' + d.deliveryAddress : ''}
${d.customerLocation && d.customerLocation.latitude ? 'Location: ' + d.customerLocation.latitude + ',' + d.customerLocation.longitude : ''}
Items:
${d.items.map(i=>`- ${i.name} x${i.quantity} (₹${i.price})`).join('\n')}
    </pre>
    <form onsubmit="return updateOrderStatus('${d._id}')">
        <select id="orderStatusSel">
            <option>Pending</option>
            <option>Confirmed</option>
            <option>Preparing</option>
            <option>Out for Delivery</option>
            <option>Delivered</option>
            <option>Cancelled</option>
        </select>
        <button style="width:50%">Update</button>
        <a href="${trk}" target="_blank" style="font-size:1.04em; color:#fff; text-decoration:underline; margin-left:.6em;">Track</a>
    </form><hr>
    `;
    document.getElementById('orderStatusSel').value = d.status;
}
async function updateOrderStatus(id) {
    let st = document.getElementById('orderStatusSel').value;
    try {
        await api(`/api/admin/orders/${id}`, {
            method:'PUT', headers:{'Content-Type': 'application/json'},
            body: JSON.stringify({status: st})
        });
        loadOrders();
        alert("Status updated");
    } catch (e) { alert("Failed to update order"); }
    return false;
}
async function deleteOrder(id) { if(confirm('Delete order?')) { await api(`/api/admin/orders/${id}`, {method:'DELETE'}); loadOrders(); } }

// --------- Menu Panel ---------
async function loadMenu() {
    let panel = document.getElementById('panel-menu');
    panel.innerHTML = "<b>Loading...</b>";
    try {
        let menu = await api('/api/admin/menu');
        panel.innerHTML = `
            <button onclick="showMenuForm()" style="width:100%;">+ Add New</button>
            <div id="menuFormWrap"></div>
            <table>
                <tr><th>Name</th><th>₹</th><th>Cat</th><th>Avail</th><th>Act</th></tr>
                ${menu.map(m=>`
                <tr>
                    <td>${m.name}</td>
                    <td>${m.price}</td>
                    <td>${m.category||''}</td>
                    <td><input type="checkbox" onchange="toggleAvailable('${m._id}',this)" ${m.isAvailable?'checked':''}/></td>
                    <td>
                        <button style="font-size:.98em;" onclick="editMenuItem('${m._id}')">✎</button>
                        <button style="font-size:.98em;" onclick="deleteMenuItem('${m._id}')">🗑</button>
                    </td>
                </tr>
                `).join('')}
            </table>
        `;
    } catch(e){ panel.innerHTML = "<span style='color:#fa0'>Can't load menu!</span>"; }
}
function showMenuForm(id=''){
    let wrap = document.getElementById('menuFormWrap');
    if(!wrap) return;
    wrap.innerHTML = `
        <form id="menuItemForm" onsubmit="return submitMenuItem('${id}')">
            <input id="mname" placeholder="Name" required>
            <input id="mprice" type="number" step="0.01" placeholder="Price" required>
            <input id="mdesc" placeholder="Description">
            <input id="murl" placeholder="Image URL">
            <input id="mcat" placeholder="Category">
            <span style="font-size:.93em;">
                <label>Trending? <input type="checkbox" id="mtrend"></label>&nbsp;&nbsp;
                <label>Available <input type="checkbox" id="mavail" checked></label>
            </span>
            <button>Save</button>
            <button onclick="hideMenuForm();return false;">Cancel</button>
        </form>
    `;
    if(id) fillMenuForm(id);
}
function hideMenuForm(){ document.getElementById('menuFormWrap').innerHTML=''; }
async function fillMenuForm(id) {
    let mi = await api(`/api/admin/menu/${id}`);
    document.getElementById('mname').value = mi.name||'';
    document.getElementById('mprice').value = mi.price||0;
    document.getElementById('mdesc').value = mi.description||'';
    document.getElementById('murl').value = mi.imageUrl||'';
    document.getElementById('mcat').value = mi.category||'';
    document.getElementById('mtrend').checked = mi.isTrending;
    document.getElementById('mavail').checked = mi.isAvailable;
}
async function submitMenuItem(id){
    let data = {
        name: document.getElementById('mname').value,
        price: parseFloat(document.getElementById('mprice').value),
        description: document.getElementById('mdesc').value,
        imageUrl: document.getElementById('murl').value,
        category: document.getElementById('mcat').value,
        isTrending: document.getElementById('mtrend').checked,
        isAvailable: document.getElementById('mavail').checked,
    };
    try {
        if(id) await api(`/api/admin/menu/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        else await api('/api/admin/menu', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        hideMenuForm();
        loadMenu();
    } catch(e){ alert("Failed to update menu"); }
    return false;
}
function editMenuItem(id){ showMenuForm(id);}
async function deleteMenuItem(id) { if(confirm('Delete menu item?')){ await api(`/api/admin/menu/${id}`, {method:'DELETE'}); loadMenu(); }}
async function toggleAvailable(id,el){ await api(`/api/admin/menu/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({isAvailable:el.checked})}); loadMenu(); }

// --------- Customers Panel ---------
async function loadCustomers() {
    let panel = document.getElementById('panel-customers');
    panel.innerHTML = "<b>Loading customers...</b>";
    try {
        let customers = await api('/api/admin/customers');
        document.getElementById('statCustomers').textContent = customers.length;
        panel.innerHTML = `
        <table>
            <tr><th>Name</th><th>Phone</th><th>Last</th><th>#</th><th>Act</th></tr>
            ${customers.map(c=>`
            <tr>
                <td>${c.customerName||''}</td>
                <td>${c.customerPhone}</td>
                <td>${c.lastOrderDate? (new Date(c.lastOrderDate)).toLocaleDateString() :''}</td>
                <td>${c.totalOrders||0}</td>
                <td>
                    <button style="font-size:.99em;" onclick="showCustomerLoc(${c.lastKnownLocation && c.lastKnownLocation.latitude ? c.lastKnownLocation.latitude : 0},${c.lastKnownLocation && c.lastKnownLocation.longitude ? c.lastKnownLocation.longitude : 0})">🏠</button>
                    <button style="font-size:.99em;" onclick="deleteCustomer('${c._id}')">🗑</button>
                </td>
            </tr>
            `).join('')}
        </table>
        <div id="map"></div>
        `;
    }catch(e){ panel.innerHTML="<span style='color:#fa0'>Can't load customers!</span>"; }
}
function showCustomerLoc(lat,lng){
    if(!lat || !lng){ alert('No location'); return; }
    let mapDiv = document.getElementById('map');
    if(!mapDiv) return;
    mapDiv.style.display='block';
    let map = L.map('map').setView([lat,lng], 15);
    window.lastDrawnMapLoc = [lat,lng];
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
    L.marker([lat,lng]).addTo(map).bindPopup("Customer").openPopup();
}
function resetCustomerMap(loc){ if(loc) showCustomerLoc(loc[0],loc[1]); }
async function deleteCustomer(id){ if(confirm('Delete?')){await api(`/api/admin/customers/${id}`,{method:'DELETE'}); loadCustomers();} }

// --------- Settings Panel ---------
async function loadSettings() {
    let panel = document.getElementById('panel-settings');
    panel.innerHTML = "<b>Loading...</b>";
    try {
        let s = await api('/api/admin/settings');
        panel.innerHTML = `
            <form onsubmit="return updateSettings()">
                <label>Shop Name <input id="sName" value="${s.shopName||''}" /></label>
                <label>Latitude <input id="sLat" value="${s.shopLocation.latitude||0}" /></label>
                <label>Longitude <input id="sLng" value="${s.shopLocation.longitude||0}" /></label>
                <label>Admin Username <input id="sAdmin" value="${s.adminUsername||''}" /></label>
                <label>Password <input id="sPass" type="password" placeholder="Change (blank to keep)" /></label>
                <button style="width:100%;">Update</button>
            </form>
            <div style="margin:1em 0 0 0; font-size:.98em;">Delivery Rates:<br>
                 ${(Array.isArray(s.deliveryRates)&&s.deliveryRates.length>0) ? s.deliveryRates.map(r=>`${r.kms}km: ₹${r.amount}`).join(' | '):'None'}
            </div>
        `;
    } catch(e){ panel.innerHTML = "<span style='color:#fa0'>Can't load settings!</span>"; }
}
async function updateSettings(){
    let shopName = document.getElementById('sName').value;
    let shopLocation = {latitude: parseFloat(document.getElementById('sLat').value), longitude: parseFloat(document.getElementById('sLng').value)};
    let adminUsername = document.getElementById('sAdmin').value;
    let adminPassword = document.getElementById('sPass').value;
    try {
        await api('/api/admin/settings', {
            method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({shopName, shopLocation, adminUsername, adminPassword: adminPassword?adminPassword:undefined})
        });
        alert("Updated!");
    }catch(e){ alert('Fail'); }
    return false;
}

// --------- Bot Panel ---------
let socket, lastQR;
async function loadBotStatus() {
    let panel = document.getElementById('panel-bot');
    panel.innerHTML = `
    <div>
        <b>Status: </b> <span id="botStatMsg">Loading...</span><br>
        <b>Last Auth: </b> <span id="botAuthTime">---</span><br>
        <button onclick="requestBotQR()">New QR</button>
        <button onclick="loadBotSession()">Reload</button>
    </div>
    <div id="qrImgArea"></div>
    `;
    try{
        let d = await api('/api/admin/bot-status');
        updateBotStatusPanel(d.status, d.lastAuthenticatedAt);
    }catch{}
}
function updateBotStatusPanel(status, lastAuthTime) {
    let statDot = document.getElementById('botStatusDot');
    let statText = document.getElementById('botStatusText');
    let statMsg = document.getElementById('botStatMsg');
    if(!statDot||!statText) return;
    statDot.className = 'status-dot status-wait';
    statText.textContent = status?status.replace(/_/g,' ').toUpperCase():'...';
    if(statMsg) statMsg.textContent = statText.textContent;
    if(status==='ready') statDot.className='status-dot status-ready';
    if(status==='disconnected'||status==='auth_failure') statDot.className='status-dot status-error';
    if(document.getElementById('botAuthTime')) document.getElementById('botAuthTime').textContent = lastAuthTime ? (new Date(lastAuthTime)).toLocaleString() : '--';
}
async function requestBotQR() { await api('/api/public/request-qr', {method:'POST'});}
async function loadBotSession(){ await api('/api/admin/load-session', {method:'POST'});}
function updateQRImage(qr){
    lastQR = qr;
    let area = document.getElementById('qrImgArea');
    area.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?margin=40&size=180x180&data=${encodeURIComponent(qr)}" style="background:#fff;padding:11px;border-radius:13px;" alt="qr"/>`;
}

// --------- REALTIME SOCKET ---------
function socketInit() {
    socket = io();
    socket.on('status', function(status){ updateBotStatusPanel(status, lastQR?undefined:null); });
    socket.on('sessionInfo', function(obj){
        if(document.getElementById('botAuthTime'))document.getElementById('botAuthTime').textContent = obj.lastAuthenticatedAt ? (new Date(obj.lastAuthenticatedAt)).toLocaleString() : '--';
    });
    socket.on('qrCode', function(qr){ updateQRImage(qr); });
}
</script>
</body>
</html>
