<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicious Bites - Order Online</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-grey background */
            color: #334155; /* Darker text for readability */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0; /* Lighter blue-grey */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6; /* Blue */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb; /* Darker Blue */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px; /* Increased max-width for better forms */
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #3b82f6; /* Blue */
            text-decoration: none;
            cursor: pointer;
        }
        .product-card {
            display: flex;
            flex-direction: column;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-in-out;
            height: 100%; /* Ensure cards are same height */
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-image {
            width: 100%;
            height: 160px; /* Fixed height for images */
            object-fit: cover;
        }
        .price-original {
            text-decoration: line-through;
            color: #6b7280; /* Gray for original price */
            margin-right: 0.5rem;
        }
        .price-discount {
            color: #10b981; /* Green for discount percentage */
            font-weight: 600;
        }
        .price-final {
            color: #3b82f6; /* Blue for final price */
            font-weight: 700;
            font-size: 1.25rem;
        }
        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
        .order-status-pending {
            color: #f59e0b; /* Amber */
        }
        .order-status-confirmed {
            color: #3b82f6; /* Blue */
        }
        .order-status-preparing {
            color: #8b5cf6; /* Violet */
        }
        .order-status-out-for-delivery {
            color: #06b6d4; /* Cyan */
        }
        .order-status-delivered {
            color: #10b981; /* Green */
        }
        .order-status-cancelled {
            color: #ef4444; /* Red */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md rounded-b-lg">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold mb-2 sm:mb-0">Delicious Bites</h1>
            <nav>
                <ul class="flex space-x-4 text-lg">
                    <li><a href="#" id="viewCartBtn" class="hover:text-blue-200 transition-colors duration-200 relative">
                        Cart (<span id="cartItemCount">0</span>)
                    </a></li>
                    <li><a href="#" id="trackOrderBtn" class="hover:text-blue-200 transition-colors duration-200">Track Order</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 flex-grow">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Our Delicious Menu</h2>

        <!-- Search and Filter -->
        <div class="mb-6 flex flex-col sm:flex-row gap-4">
            <input type="text" id="menuSearch" placeholder="Search menu items..." class="flex-grow px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            <select id="menuCategoryFilter" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Categories</option>
            </select>
        </div>

        <!-- Menu Items Grid -->
        <div id="menuItemsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Menu items will be loaded here -->
        </div>
        <p id="noMenuItemsMessage" class="text-center text-gray-500 mt-8 hidden">No menu items found matching your criteria.</p>
        <p id="loadingMessage" class="text-center text-blue-500 mt-8">Loading menu...</p>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-600 text-white p-4 mt-8 rounded-t-lg">
        <div class="container mx-auto text-center text-sm">
            &copy; 2025 Delicious Bites. All rights reserved.
        </div>
    </footer>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCartModal">&times;</span>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Your Cart</h3>
            <div id="cartItemsContainer" class="max-h-80 overflow-y-auto mb-4 border rounded-md p-2">
                <!-- Cart items will be loaded here -->
            </div>
            <div id="cartSummary" class="border-t pt-4">
                <p class="flex justify-between text-lg font-medium">Subtotal: <span id="cartSubtotal">â‚¹0.00</span></p>
                <p class="flex justify-between text-lg font-medium">Transport Tax: <span id="cartTransportTax">â‚¹0.00</span></p>
                <p class="flex justify-between text-lg font-medium text-green-600">Discount: <span id="cartDiscount">-â‚¹0.00</span></p>
                <p class="flex justify-between text-xl font-bold mt-2">Total: <span id="cartTotal">â‚¹0.00</span></p>
            </div>

            <button id="checkoutBtn" class="w-full bg-blue-500 text-white py-3 px-4 rounded-md hover:bg-blue-600 transition-colors duration-300 font-semibold mt-6">
                Proceed to Checkout
            </button>
            <button id="clearCartBtn" class="w-full bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors duration-300 font-semibold mt-2">
                Clear Cart
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCheckoutModal">&times;</span>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Checkout Details</h3>
            <form id="checkoutForm" class="space-y-4">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700">Your Name</label>
                    <input type="text" id="customerName" name="customerName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="customerPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="customerPhone" name="customerPhone" placeholder="e.g., 9876543210" pattern="[0-9]{10}" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="deliveryAddress" class="block text-sm font-medium text-gray-700">Delivery Address</label>
                    <textarea id="deliveryAddress" name="deliveryAddress" rows="3" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="useCurrentLocation" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="useCurrentLocation" class="ml-2 block text-sm text-gray-900">Use my current location (for delivery calculation)</label>
                </div>
                <div id="locationMessage" class="text-sm text-gray-500 mt-2 hidden"></div>

                <div class="border-t pt-4">
                    <p class="flex justify-between text-lg font-medium">Subtotal: <span id="checkoutSubtotal">â‚¹0.00</span></p>
                    <p class="flex justify-between text-lg font-medium">Transport Tax: <span id="checkoutTransportTax">â‚¹0.00</span></p>
                    <p class="flex justify-between text-lg font-medium text-green-600">Discount: <span id="checkoutDiscount">-â‚¹0.00</span></p>
                    <p class="flex justify-between text-xl font-bold mt-2">Total: <span id="checkoutTotal">â‚¹0.00</span></p>
                </div>

                <div id="checkoutErrorMessage" class="text-red-600 text-sm text-center hidden"></div>
                <button type="submit" class="w-full bg-blue-500 text-white py-3 px-4 rounded-md hover:bg-blue-600 transition-colors duration-300 font-semibold">
                    Place Order (Cash on Delivery)
                </button>
            </form>
        </div>
    </div>

    <!-- Order Tracking Modal -->
    <div id="trackOrderModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeTrackOrderModal">&times;</span>
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Track Your Order</h3>
            <div class="mb-4">
                <label for="orderLookupId" class="block text-sm font-medium text-gray-700">Enter Order ID or PIN</label>
                <input type="text" id="orderLookupId" placeholder="e.g., JAR123456ABCD or 1234567890" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="lookupOrderBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors duration-300 font-semibold mb-4">
                Track Order
            </button>
            <div id="orderStatusDisplay" class="border-t pt-4 hidden">
                <p><strong>Order ID:</strong> <span id="trackedOrderId"></span></p>
                <p><strong>PIN:</strong> <span id="trackedPinId"></span></p>
                <p><strong>Status:</strong> <span id="trackedOrderStatus"></span></p>
                <p><strong>Total:</strong> <span id="trackedOrderTotal"></span></p>
                <p><strong>Items:</strong> <span id="trackedOrderItems"></span></p>
                <p><strong>Order Date:</strong> <span id="trackedOrderDate"></span></p>
            </div>
            <div id="trackOrderMessage" class="text-red-600 text-sm text-center mt-4 hidden"></div>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div id="orderConfirmationModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Order Placed Successfully! ðŸŽ‰</h3>
            <p class="text-gray-700 mb-4">Your order has been received. You will get a WhatsApp message with details shortly.</p>
            <p class="text-lg font-bold text-blue-600 mb-2">Your Order ID: <span id="confirmedOrderId"></span></p>
            <p class="text-lg font-bold text-blue-600 mb-4">Your PIN: <span id="confirmedPinId"></span></p>
            <p class="text-gray-600 text-sm">Use this PIN to track your order status.</p>
            <button id="closeConfirmationModal" class="w-full bg-blue-500 text-white py-3 px-4 rounded-md hover:bg-blue-600 transition-colors duration-300 font-semibold mt-6">
                Got It!
            </button>
        </div>
    </div>


    <script>
        // Global state for menu items and cart
        let allMenuItems = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let shopSettings = {};
        let customerLocation = null; // Stores {latitude, longitude}

        // --- Utility Functions ---
        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ message: response.statusText }));
                    console.error(`Error fetching ${url}:`, response.status, errorBody.message);
                    throw new Error(errorBody.message || `Failed to fetch data from ${url}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Network error fetching ${url}:`, error);
                throw new Error(`Network error: ${error.message}`);
            }
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartItemCount').textContent = totalItems;
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
        }

        function calculateCartSummary() {
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });

            let transportTax = 0;
            if (customerLocation && shopSettings.deliveryRates && shopSettings.shopLocation) {
                const distance = calculateDistance(
                    customerLocation.latitude, customerLocation.longitude,
                    shopSettings.shopLocation.latitude, shopSettings.shopLocation.longitude
                );
                // Find the appropriate delivery rate
                const applicableRate = shopSettings.deliveryRates
                    .filter(rate => distance <= rate.kms)
                    .sort((a, b) => a.kms - b.kms)[0]; // Get the lowest applicable rate

                transportTax = applicableRate ? applicableRate.amount : 0;
            }

            let discountAmount = 0;
            if (shopSettings.minSubtotalForDiscount && subtotal >= shopSettings.minSubtotalForDiscount) {
                discountAmount = subtotal * (shopSettings.discountPercentage || 0);
            }

            const totalAmount = subtotal + transportTax - discountAmount;

            return { subtotal, transportTax, discountAmount, totalAmount };
        }

        // Haversine formula to calculate distance between two lat/lon points in kilometers
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            return distance;
        }

        function showModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function hideModal(modalElement) {
            modalElement.style.display = 'none';
        }

        function showMessage(elementId, message, isError = true) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden', 'text-red-600', 'text-green-600');
            element.classList.add(isError ? 'text-red-600' : 'text-green-600');
        }

        function hideMessage(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // --- Menu Rendering ---
        async function loadMenu() {
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('menuItemsGrid').innerHTML = ''; // Clear previous items
            document.getElementById('noMenuItemsMessage').classList.add('hidden');

            try {
                const menuData = await fetchData('/api/menu');
                allMenuItems = menuData;
                renderMenuItems(); // Initial render
                populateCategoryFilter();
            } catch (error) {
                document.getElementById('menuItemsGrid').innerHTML = `<p class="text-center text-red-600 col-span-full">Failed to load menu: ${error.message}</p>`;
            } finally {
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }

        function populateCategoryFilter() {
            const categories = [...new Set(allMenuItems.map(item => item.category).filter(Boolean))];
            const filterSelect = document.getElementById('menuCategoryFilter');
            filterSelect.innerHTML = '<option value="">All Categories</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderMenuItems() {
            const menuItemsGrid = document.getElementById('menuItemsGrid');
            menuItemsGrid.innerHTML = '';
            document.getElementById('noMenuItemsMessage').classList.add('hidden');

            const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
            const filterCategory = document.getElementById('menuCategoryFilter').value;

            const filteredItems = allMenuItems.filter(item => {
                const matchesSearch = (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                                    (item.description && item.description.toLowerCase().includes(searchTerm)) ||
                                    (item.category && item.category.toLowerCase().includes(searchTerm));
                const matchesCategory = filterCategory === '' || item.category === filterCategory;
                return item.isAvailable && matchesSearch && matchesCategory;
            });

            if (filteredItems.length === 0) {
                document.getElementById('noMenuItemsMessage').classList.remove('hidden');
                return;
            }

            filteredItems.forEach(item => {
                const cartItem = cart.find(cItem => cItem._id === item._id);
                const quantityInCart = cartItem ? cartItem.quantity : 0;

                let priceDisplay = `<span class="price-final">â‚¹${item.price.toFixed(2)}</span>`;
                if (item.displayOriginalPrice && item.displayOriginalPrice > item.price) {
                    const discountPercentage = ((item.displayOriginalPrice - item.price) / item.displayOriginalPrice * 100).toFixed(0);
                    priceDisplay = `
                        <span class="price-original">â‚¹${item.displayOriginalPrice.toFixed(2)}</span>
                        <span class="price-final">â‚¹${item.price.toFixed(2)}</span>
                        <span class="price-discount ml-2">${discountPercentage}% OFF</span>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'product-card bg-white rounded-lg shadow-md hover:shadow-xl';
                card.innerHTML = `
                    <img src="${item.imageUrl || 'https://placehold.co/400x200/E2E8F0/64748B?text=No+Image'}" alt="${item.name}" class="product-image">
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">${item.name} ${item.isTrending ? '<span class="text-purple-500 text-sm font-normal">âœ¨ Trending</span>' : ''}</h3>
                        <p class="text-gray-600 text-sm mb-3 flex-grow">${item.description || ''}</p>
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-baseline">
                                ${priceDisplay}
                            </div>
                            <span class="text-gray-500 text-sm">${item.category || 'Other'}</span>
                        </div>
                        <div class="flex items-center justify-center mt-auto">
                            <button class="bg-gray-200 text-gray-700 px-3 py-1 rounded-l-md hover:bg-gray-300 transition-colors duration-200 decrease-quantity" data-id="${item._id}">-</button>
                            <span class="bg-gray-100 text-gray-800 px-4 py-1 border-t border-b border-gray-300 quantity-display" data-id="${item._id}">${quantityInCart}</span>
                            <button class="bg-blue-500 text-white px-3 py-1 rounded-r-md hover:bg-blue-600 transition-colors duration-200 increase-quantity" data-id="${item._id}">+</button>
                        </div>
                    </div>
                `;
                menuItemsGrid.appendChild(card);
            });

            // Add event listeners for quantity buttons
            menuItemsGrid.querySelectorAll('.increase-quantity').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    const item = allMenuItems.find(i => i._id === itemId);
                    if (item) {
                        const cartItem = cart.find(cItem => cItem._id === itemId);
                        if (cartItem) {
                            cartItem.quantity++;
                        } else {
                            cart.push({ ...item, quantity: 1 });
                        }
                        saveCart();
                        renderMenuItems(); // Re-render to update quantity display
                    }
                });
            });

            menuItemsGrid.querySelectorAll('.decrease-quantity').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    const cartItemIndex = cart.findIndex(cItem => cItem._id === itemId);
                    if (cartItemIndex > -1) {
                        if (cart[cartItemIndex].quantity > 1) {
                            cart[cartItemIndex].quantity--;
                        } else {
                            cart.splice(cartItemIndex, 1); // Remove item if quantity is 1
                        }
                        saveCart();
                        renderMenuItems(); // Re-render to update quantity display
                    }
                });
            });
        }

        // --- Cart Modal Logic ---
        function renderCartModal() {
            const cartItemsContainer = document.getElementById('cartItemsContainer');
            cartItemsContainer.innerHTML = '';
            const { subtotal, transportTax, discountAmount, totalAmount } = calculateCartSummary();

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Your cart is empty.</p>';
                document.getElementById('checkoutBtn').disabled = true;
                document.getElementById('clearCartBtn').disabled = true;
            } else {
                cart.forEach(item => {
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'flex items-center justify-between py-2 border-b last:border-b-0';
                    cartItemDiv.innerHTML = `
                        <div class="flex items-center">
                            <img src="${item.imageUrl || 'https://placehold.co/60x60/E2E8F0/64748B?text=Item'}" alt="${item.name}" class="cart-item-image mr-3">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-600">â‚¹${item.price.toFixed(2)} each</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <button class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded-l-md hover:bg-gray-300 decrease-cart-quantity" data-id="${item._id}">-</button>
                            <span class="bg-gray-100 text-gray-800 px-3 py-0.5 border-t border-b border-gray-300">${item.quantity}</span>
                            <button class="bg-blue-500 text-white px-2 py-0.5 rounded-r-md hover:bg-blue-600 increase-cart-quantity" data-id="${item._id}">+</button>
                            <button class="ml-3 text-red-500 hover:text-red-700 remove-from-cart" data-id="${item._id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                });
                document.getElementById('checkoutBtn').disabled = false;
                document.getElementById('clearCartBtn').disabled = false;
            }

            document.getElementById('cartSubtotal').textContent = `â‚¹${subtotal.toFixed(2)}`;
            document.getElementById('cartTransportTax').textContent = `â‚¹${transportTax.toFixed(2)}`;
            document.getElementById('cartDiscount').textContent = `-â‚¹${discountAmount.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `â‚¹${totalAmount.toFixed(2)}`;

            // Add event listeners for cart quantity buttons
            cartItemsContainer.querySelectorAll('.increase-cart-quantity').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    const cartItem = cart.find(cItem => cItem._id === itemId);
                    if (cartItem) {
                        cartItem.quantity++;
                        saveCart();
                        renderCartModal();
                        renderMenuItems(); // Update main menu display
                    }
                });
            });

            cartItemsContainer.querySelectorAll('.decrease-cart-quantity').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    const cartItemIndex = cart.findIndex(cItem => cItem._id === itemId);
                    if (cartItemIndex > -1) {
                        if (cart[cartItemIndex].quantity > 1) {
                            cart[cartItemIndex].quantity--;
                        } else {
                            cart.splice(cartItemIndex, 1);
                        }
                        saveCart();
                        renderCartModal();
                        renderMenuItems(); // Update main menu display
                    }
                });
            });

            cartItemsContainer.querySelectorAll('.remove-from-cart').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    cart = cart.filter(cItem => cItem._id !== itemId);
                    saveCart();
                    renderCartModal();
                    renderMenuItems(); // Update main menu display
                });
            });
        }

        // --- Checkout Modal Logic ---
        function renderCheckoutModal() {
            hideMessage('checkoutErrorMessage');
            const { subtotal, transportTax, discountAmount, totalAmount } = calculateCartSummary();

            document.getElementById('checkoutSubtotal').textContent = `â‚¹${subtotal.toFixed(2)}`;
            document.getElementById('checkoutTransportTax').textContent = `â‚¹${transportTax.toFixed(2)}`;
            document.getElementById('checkoutDiscount').textContent = `-â‚¹${discountAmount.toFixed(2)}`;
            document.getElementById('checkoutTotal').textContent = `â‚¹${totalAmount.toFixed(2)}`;

            // Pre-fill fields from local storage if available
            document.getElementById('customerName').value = localStorage.getItem('customerName') || '';
            document.getElementById('customerPhone').value = localStorage.getItem('customerPhone') || '';
            document.getElementById('deliveryAddress').value = localStorage.getItem('deliveryAddress') || '';

            // Handle location checkbox
            const useCurrentLocationCheckbox = document.getElementById('useCurrentLocation');
            const locationMessage = document.getElementById('locationMessage');
            useCurrentLocationCheckbox.checked = false; // Reset on modal open

            useCurrentLocationCheckbox.addEventListener('change', async () => {
                if (useCurrentLocationCheckbox.checked) {
                    locationMessage.classList.remove('hidden');
                    locationMessage.textContent = 'Getting your location...';
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
                        });
                        customerLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        locationMessage.textContent = 'Location obtained. Transport tax updated.';
                        // Recalculate and update summary with new location
                        const updatedSummary = calculateCartSummary();
                        document.getElementById('checkoutTransportTax').textContent = `â‚¹${updatedSummary.transportTax.toFixed(2)}`;
                        document.getElementById('checkoutTotal').textContent = `â‚¹${updatedSummary.totalAmount.toFixed(2)}`;
                    } catch (error) {
                        console.error('Error getting location:', error);
                        customerLocation = null; // Clear location on error
                        useCurrentLocationCheckbox.checked = false; // Uncheck on error
                        locationMessage.textContent = 'Could not get location. Please allow location access or enter address manually.';
                        locationMessage.classList.add('text-red-600');
                        // Recalculate without location
                        const updatedSummary = calculateCartSummary();
                        document.getElementById('checkoutTransportTax').textContent = `â‚¹${updatedSummary.transportTax.toFixed(2)}`;
                        document.getElementById('checkoutTotal').textContent = `â‚¹${updatedSummary.totalAmount.toFixed(2)}`;
                    }
                } else {
                    customerLocation = null;
                    locationMessage.classList.add('hidden');
                    // Recalculate without location
                    const updatedSummary = calculateCartSummary();
                    document.getElementById('checkoutTransportTax').textContent = `â‚¹${updatedSummary.transportTax.toFixed(2)}`;
                    document.getElementById('checkoutTotal').textContent = `â‚¹${updatedSummary.totalAmount.toFixed(2)}`;
                }
            });
        }

        // --- Order Tracking Modal Logic ---
        async function renderTrackOrderModal(initialOrderId = '') {
            hideMessage('trackOrderMessage');
            document.getElementById('orderStatusDisplay').classList.add('hidden');
            document.getElementById('orderLookupId').value = initialOrderId;

            if (initialOrderId) {
                await lookupOrder(); // Auto-lookup if ID is provided
            }
        }

        async function lookupOrder() {
            hideMessage('trackOrderMessage');
            document.getElementById('orderStatusDisplay').classList.add('hidden');
            const orderLookupId = document.getElementById('orderLookupId').value.trim();

            if (!orderLookupId) {
                showMessage('trackOrderMessage', 'Please enter an Order ID or PIN.');
                return;
            }

            try {
                const order = await fetchData(`/api/order/${orderLookupId}`);
                if (order) {
                    document.getElementById('trackedOrderId').textContent = order.customOrderId || order._id;
                    document.getElementById('trackedPinId').textContent = order.pinId || 'N/A';
                    document.getElementById('trackedOrderStatus').textContent = order.status;
                    document.getElementById('trackedOrderStatus').className = `font-bold order-status-${order.status.toLowerCase().replace(/\s/g, '-')}`;
                    document.getElementById('trackedOrderTotal').textContent = `â‚¹${order.totalAmount.toFixed(2)}`;
                    document.getElementById('trackedOrderItems').textContent = order.items.map(item => `${item.name} x ${item.quantity}`).join(', ');
                    document.getElementById('trackedOrderDate').textContent = new Date(order.orderDate).toLocaleString();
                    document.getElementById('orderStatusDisplay').classList.remove('hidden');
                } else {
                    showMessage('trackOrderMessage', 'Order not found. Please check the ID or PIN.');
                }
            } catch (error) {
                showMessage('trackOrderMessage', 'Error tracking order: ' + error.message);
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Load shop settings first to get delivery rates and shop location
            try {
                shopSettings = await fetchData('/api/public/settings');
                if (!shopSettings.deliveryRates) shopSettings.deliveryRates = [];
                if (!shopSettings.shopLocation) shopSettings.shopLocation = { latitude: 0, longitude: 0 };
            } catch (error) {
                console.error('Failed to load shop settings:', error);
                alert('Failed to load shop settings. Delivery tax calculation might be inaccurate.');
            }

            loadMenu(); // Load menu items after settings

            // Menu search and filter
            document.getElementById('menuSearch').addEventListener('input', renderMenuItems);
            document.getElementById('menuCategoryFilter').addEventListener('change', renderMenuItems);

            // Cart Modal
            const cartModal = document.getElementById('cartModal');
            document.getElementById('viewCartBtn').addEventListener('click', (e) => {
                e.preventDefault();
                renderCartModal();
                showModal(cartModal);
            });
            document.getElementById('closeCartModal').addEventListener('click', () => hideModal(cartModal));
            document.getElementById('clearCartBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear your cart?')) {
                    cart = [];
                    saveCart();
                    renderCartModal();
                    renderMenuItems(); // Update main menu display
                }
            });

            // Checkout Modal
            const checkoutModal = document.getElementById('checkoutModal');
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                hideModal(cartModal); // Close cart modal
                renderCheckoutModal();
                showModal(checkoutModal);
            });
            document.getElementById('closeCheckoutModal').addEventListener('click', () => hideModal(checkoutModal));

            document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('checkoutErrorMessage');

                const customerName = document.getElementById('customerName').value.trim();
                const customerPhone = document.getElementById('customerPhone').value.trim();
                const deliveryAddress = document.getElementById('deliveryAddress').value.trim();

                if (cart.length === 0) {
                    showMessage('checkoutErrorMessage', 'Your cart is empty. Please add items before placing an order.');
                    return;
                }
                if (!customerName || !customerPhone || !deliveryAddress) {
                    showMessage('checkoutErrorMessage', 'Please fill in all required customer and address details.');
                    return;
                }
                if (!/^[0-9]{10}$/.test(customerPhone)) {
                    showMessage('checkoutErrorMessage', 'Please enter a valid 10-digit phone number.');
                    return;
                }

                // Save customer details to local storage
                localStorage.setItem('customerName', customerName);
                localStorage.setItem('customerPhone', customerPhone);
                localStorage.setItem('deliveryAddress', deliveryAddress);

                const { subtotal, transportTax, discountAmount, totalAmount } = calculateCartSummary();

                const orderPayload = {
                    items: cart.map(item => ({
                        productId: item._id, // Ensure this matches backend expected field
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    })),
                    customerName,
                    customerPhone,
                    deliveryAddress,
                    customerLocation: customerLocation, // Can be null if not used
                    subtotal,
                    transportTax,
                    discountAmount,
                    totalAmount,
                    paymentMethod: 'Cash on Delivery' // Hardcoded as per server.js
                };

                try {
                    const result = await fetchData('/api/order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderPayload)
                    });

                    // Show confirmation modal
                    document.getElementById('confirmedOrderId').textContent = result.orderId;
                    document.getElementById('confirmedPinId').textContent = result.pinId;
                    showModal(document.getElementById('orderConfirmationModal'));

                    // Clear cart after successful order
                    cart = [];
                    saveCart();
                    renderMenuItems(); // Update menu quantities
                    hideModal(checkoutModal); // Close checkout modal

                } catch (error) {
                    showMessage('checkoutErrorMessage', 'Failed to place order: ' + error.message);
                }
            });

            // Order Confirmation Modal
            document.getElementById('closeConfirmationModal').addEventListener('click', () => {
                hideModal(document.getElementById('orderConfirmationModal'));
                // Optionally redirect to menu or home
            });


            // Order Tracking Modal
            const trackOrderModal = document.getElementById('trackOrderModal');
            document.getElementById('trackOrderBtn').addEventListener('click', (e) => {
                e.preventDefault();
                // Check if an orderId was passed in the URL (e.g., from WhatsApp bot)
                const urlParams = new URLSearchParams(window.location.search);
                const initialOrderId = urlParams.get('orderId') || '';
                renderTrackOrderModal(initialOrderId);
                showModal(trackOrderModal);
            });
            document.getElementById('closeTrackOrderModal').addEventListener('click', () => hideModal(trackOrderModal));
            document.getElementById('lookupOrderBtn').addEventListener('click', lookupOrder);

            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target == cartModal) hideModal(cartModal);
                if (event.target == checkoutModal) hideModal(checkoutModal);
                if (event.target == trackOrderModal) hideModal(trackOrderModal);
                if (event.target == document.getElementById('orderConfirmationModal')) hideModal(document.getElementById('orderConfirmationModal'));
            });

            // Initial cart count update
            updateCartCount();

            // Check URL for orderId to auto-open tracking modal
            const urlParams = new URLSearchParams(window.location.search);
            const initialOrderIdFromUrl = urlParams.get('orderId');
            if (initialOrderIdFromUrl) {
                // Delay opening the modal slightly to ensure DOM is fully ready
                setTimeout(() => {
                    renderTrackOrderModal(initialOrderIdFromUrl);
                    showModal(trackOrderModal);
                }, 500);
            }
        });
    </script>
</body>
</html>

